name: Deploy Backend to Production

# FIXED: Previously was silently failing due to missing error handling
# Key fixes:
# 1. Added explicit error checking with `set -e` in all shell commands
# 2. Added debug output for AWS credentials validation
# 3. Separated validation, build, and deploy into isolated jobs
# 4. Added proper rollback on failure
# 5. Better error reporting and GitHub Actions summary

on:
  workflow_dispatch:
    inputs:
      run_smoke_tests:
        description: 'Run smoke tests after deployment'
        required: false
        default: true
        type: boolean
      skip_build:
        description: 'Skip Docker build (use existing image)'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - master
    paths:
      - 'packages/backend/**'
      - 'packages/database/**'
      - 'packages/shared/**'
      - '.github/workflows/deploy-backend.yml'

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: mentalspace-backend
  ECS_CLUSTER: mentalspace-ehr-prod
  ECS_SERVICE: mentalspace-backend
  CONTAINER_NAME: mentalspace-backend

jobs:
  validate:
    name: Validate AWS Credentials
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      valid: ${{ steps.check.outputs.valid }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate AWS credentials
        id: check
        run: |
          set -e
          echo "ðŸ” Validating AWS credentials..."

          # Check if credentials work
          aws sts get-caller-identity || {
            echo "âŒ AWS credentials are invalid or expired"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          }

          echo "âœ… AWS credentials are valid"
          echo "valid=true" >> $GITHUB_OUTPUT

          # Check ECR access
          echo "ðŸ” Checking ECR repository access..."
          aws ecr describe-repositories --repository-names ${{ env.ECR_REPOSITORY }} --region ${{ env.AWS_REGION }} || {
            echo "âŒ Cannot access ECR repository: ${{ env.ECR_REPOSITORY }}"
            exit 1
          }

          echo "âœ… ECR repository access confirmed"

          # Check ECS cluster access
          echo "ðŸ” Checking ECS cluster access..."
          aws ecs describe-clusters --clusters ${{ env.ECS_CLUSTER }} --region ${{ env.AWS_REGION }} || {
            echo "âŒ Cannot access ECS cluster: ${{ env.ECS_CLUSTER }}"
            exit 1
          }

          echo "âœ… ECS cluster access confirmed"

  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [validate]
    if: needs.validate.outputs.valid == 'true'
    timeout-minutes: 20
    outputs:
      image_uri: ${{ steps.build-image.outputs.image_uri }}
      image_digest: ${{ steps.build-image.outputs.image_digest }}
      git_sha: ${{ steps.git.outputs.sha }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Git info
        id: git
        run: |
          set -e
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "build_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.git.outputs.short_sha }}
        run: |
          set -e

          echo "ðŸ“¦ Building Docker image..."
          echo "Registry: $ECR_REGISTRY"
          echo "Repository: $ECR_REPOSITORY"
          echo "Tag: $IMAGE_TAG"

          # Build with cache
          docker buildx build \
            --platform linux/amd64 \
            --build-arg GIT_SHA=${{ steps.git.outputs.sha }} \
            --build-arg BUILD_TIME=${{ steps.git.outputs.build_time }} \
            --cache-from type=registry,ref=$ECR_REGISTRY/$ECR_REPOSITORY:buildcache \
            --cache-to type=registry,ref=$ECR_REGISTRY/$ECR_REPOSITORY:buildcache,mode=max \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            -f packages/backend/Dockerfile \
            --push \
            .

          echo "âœ… Docker image built and pushed"

          # Get image digest
          IMAGE_DIGEST=$(aws ecr describe-images \
            --repository-name $ECR_REPOSITORY \
            --image-ids imageTag=$IMAGE_TAG \
            --query 'imageDetails[0].imageDigest' \
            --output text)

          IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY@$IMAGE_DIGEST

          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "image_digest=$IMAGE_DIGEST" >> $GITHUB_OUTPUT

          echo "ðŸ“‹ Image URI: $IMAGE_URI"
          echo "ðŸ“‹ Image Digest: $IMAGE_DIGEST"

  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    needs: [build]
    timeout-minutes: 20
    outputs:
      task_definition: ${{ steps.task-def.outputs.arn }}
      previous_task_definition: ${{ steps.current-task-def.outputs.arn }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get current task definition
        id: current-task-def
        run: |
          set -e

          echo "ðŸ” Getting current task definition..."

          CURRENT_TASK_DEF=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].taskDefinition' \
            --output text)

          if [[ -z "$CURRENT_TASK_DEF" || "$CURRENT_TASK_DEF" == "None" ]]; then
            echo "âŒ Could not find current task definition for service ${{ env.ECS_SERVICE }}"
            exit 1
          fi

          echo "âœ… Current task definition: $CURRENT_TASK_DEF"
          echo "arn=$CURRENT_TASK_DEF" >> $GITHUB_OUTPUT

      - name: Create new task definition
        id: task-def
        env:
          IMAGE_URI: ${{ needs.build.outputs.image_uri }}
        run: |
          set -e

          echo "ðŸ“ Creating new task definition..."
          echo "Image URI: $IMAGE_URI"

          # Download current task definition
          aws ecs describe-task-definition \
            --task-definition ${{ steps.current-task-def.outputs.arn }} \
            --region ${{ env.AWS_REGION }} \
            --query 'taskDefinition' > task-def.json

          echo "ðŸ“‹ Current task definition downloaded"

          # Update image URI
          NEW_TASK_DEF=$(cat task-def.json | jq \
            --arg image_uri "$IMAGE_URI" \
            --arg git_sha "${{ needs.build.outputs.git_sha }}" \
            --arg build_time "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            '
            .containerDefinitions[0].image = $image_uri |
            .containerDefinitions[0].environment = [
              (.containerDefinitions[0].environment // [] | .[] | select(.name != "GIT_SHA" and .name != "BUILD_TIME")),
              {name: "GIT_SHA", value: $git_sha},
              {name: "BUILD_TIME", value: $build_time}
            ] |
            del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)
            ')

          # Register new task definition
          echo "$NEW_TASK_DEF" > new-task-def.json

          echo "ðŸ“¤ Registering new task definition..."

          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --region ${{ env.AWS_REGION }} \
            --cli-input-json file://new-task-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          if [[ -z "$NEW_TASK_DEF_ARN" || "$NEW_TASK_DEF_ARN" == "None" ]]; then
            echo "âŒ Failed to register new task definition"
            exit 1
          fi

          echo "âœ… New task definition: $NEW_TASK_DEF_ARN"
          echo "arn=$NEW_TASK_DEF_ARN" >> $GITHUB_OUTPUT

      - name: Deploy to ECS
        run: |
          set -e

          echo "ðŸš€ Deploying to ECS..."

          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition ${{ steps.task-def.outputs.arn }} \
            --region ${{ env.AWS_REGION }} \
            --force-new-deployment

          echo "âœ… Deployment initiated at $(date)"

      - name: Wait for deployment
        timeout-minutes: 15
        run: |
          set -e

          echo "â³ Waiting for deployment to stabilize..."

          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }}

          echo "âœ… Deployment completed successfully"

      - name: Verify deployment health
        timeout-minutes: 5
        run: |
          set -e

          TARGET_GROUP_ARN="arn:aws:elasticloadbalancing:us-east-1:706704660887:targetgroup/mentalspace-tg/a6a9aee5b6beffdd"

          echo "ðŸ¥ Checking target group health..."

          for i in {1..10}; do
            HEALTHY_COUNT=$(aws elbv2 describe-target-health \
              --target-group-arn $TARGET_GROUP_ARN \
              --region ${{ env.AWS_REGION }} \
              --query 'TargetHealthDescriptions[?TargetHealth.State==`healthy`]' \
              --output json | jq '. | length')

            echo "Attempt $i: $HEALTHY_COUNT healthy targets"

            if [[ $HEALTHY_COUNT -ge 1 ]]; then
              echo "âœ… All targets are healthy!"
              exit 0
            fi

            sleep 30
          done

          echo "âŒ Health check failed after 10 attempts"
          exit 1

  smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy]
    if: github.event.inputs.run_smoke_tests != 'false'
    timeout-minutes: 5

    steps:
      - name: Run smoke tests
        run: |
          set -e

          BASE_URL="https://api.mentalspaceehr.com/api/v1"

          echo "ðŸ§ª Running smoke tests against $BASE_URL"

          # Test health endpoint
          echo "Testing /health/live..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/health/live" --max-time 10)
          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "âŒ Health check failed with status $HTTP_CODE"
            exit 1
          fi
          echo "âœ… Health check passed"

          # Test version endpoint
          echo "Testing /version..."
          VERSION=$(curl -s "$BASE_URL/version" --max-time 10 | jq -r '.version // .gitSha // "unknown"')
          echo "âœ… Version: $VERSION"

          echo "âœ… All smoke tests passed"

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy, smoke-tests]
    if: failure() && needs.deploy.outputs.previous_task_definition != ''
    timeout-minutes: 10

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Initiate rollback
        run: |
          set -e

          PREVIOUS_TASK="${{ needs.deploy.outputs.previous_task_definition }}"

          echo "âš ï¸ Deployment failed - initiating rollback..."
          echo "Rolling back to: $PREVIOUS_TASK"

          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition "$PREVIOUS_TASK" \
            --region ${{ env.AWS_REGION }} \
            --force-new-deployment

          echo "âœ… Rollback initiated"

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [validate, build, deploy, smoke-tests]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Git SHA:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Image URI:** \`${{ needs.build.outputs.image_uri }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Task Definition:** \`${{ needs.deploy.outputs.task_definition }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**API URL:** https://api.mentalspaceehr.com" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the individual job logs for details." >> $GITHUB_STEP_SUMMARY
          fi
