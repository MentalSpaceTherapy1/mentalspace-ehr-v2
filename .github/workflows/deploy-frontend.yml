name: Deploy Frontend to Production

on:
  push:
    branches: [master]
    paths:
      - 'packages/frontend/**'
      - 'packages/shared/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '20.x'
  AWS_REGION: us-east-1

jobs:
  # ===========================================
  # Job 1: Build Frontend
  # ===========================================
  build:
    name: Build Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fix Rollup platform binaries
        run: |
          # Force install Linux-specific Rollup binary
          # This fixes cross-platform lockfile issues with optional dependencies
          npm install @rollup/rollup-linux-x64-gnu --save-optional --force

      - name: Build shared package
        run: |
          cd packages/shared
          npm run build

      - name: Build frontend
        env:
          VITE_API_URL: ${{ github.event.inputs.environment == 'staging' && 'https://api-staging.mentalspaceehr.com/api/v1' || 'https://api.mentalspaceehr.com/api/v1' }}
          VITE_SOCKET_URL: ${{ github.event.inputs.environment == 'staging' && 'wss://api-staging.mentalspaceehr.com' || 'wss://api.mentalspaceehr.com' }}
        run: |
          cd packages/frontend
          npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: packages/frontend/dist
          retention-days: 1

  # ===========================================
  # Job 2: Deploy to S3 and Invalidate CloudFront
  # ===========================================
  deploy:
    name: Deploy to S3
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist

      - name: Set deployment variables
        id: vars
        run: |
          if [ "${{ github.event.inputs.environment }}" == "staging" ]; then
            echo "S3_BUCKET=mentalspace-ehr-frontend-staging" >> $GITHUB_OUTPUT
            echo "CLOUDFRONT_DISTRIBUTION_ID=${{ secrets.STAGING_CLOUDFRONT_DISTRIBUTION_ID }}" >> $GITHUB_OUTPUT
            echo "SITE_URL=https://staging.mentalspaceehr.com" >> $GITHUB_OUTPUT
          else
            echo "S3_BUCKET=mentalspaceehr-frontend" >> $GITHUB_OUTPUT
            echo "CLOUDFRONT_DISTRIBUTION_ID=E3AL81URAGOXL4" >> $GITHUB_OUTPUT
            echo "SITE_URL=https://www.mentalspaceehr.com" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to S3
        run: |
          echo "Deploying to S3 bucket: ${{ steps.vars.outputs.S3_BUCKET }}"
          aws s3 sync dist/ s3://${{ steps.vars.outputs.S3_BUCKET }} --delete

      - name: Set cache headers for assets
        run: |
          # Set long cache for hashed assets (immutable)
          aws s3 cp s3://${{ steps.vars.outputs.S3_BUCKET }}/assets/ s3://${{ steps.vars.outputs.S3_BUCKET }}/assets/ \
            --recursive \
            --metadata-directive REPLACE \
            --cache-control "public, max-age=31536000, immutable" \
            --content-type "application/javascript" \
            --exclude "*" --include "*.js"

          aws s3 cp s3://${{ steps.vars.outputs.S3_BUCKET }}/assets/ s3://${{ steps.vars.outputs.S3_BUCKET }}/assets/ \
            --recursive \
            --metadata-directive REPLACE \
            --cache-control "public, max-age=31536000, immutable" \
            --content-type "text/css" \
            --exclude "*" --include "*.css"

          # Set short cache for index.html (always fresh)
          aws s3 cp s3://${{ steps.vars.outputs.S3_BUCKET }}/index.html s3://${{ steps.vars.outputs.S3_BUCKET }}/index.html \
            --metadata-directive REPLACE \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "text/html"

      - name: Invalidate CloudFront cache
        run: |
          echo "Invalidating CloudFront distribution: ${{ steps.vars.outputs.CLOUDFRONT_DISTRIBUTION_ID }}"
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ steps.vars.outputs.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          echo "Invalidation ID: $INVALIDATION_ID"

          # Wait for invalidation to complete
          echo "Waiting for invalidation to complete..."
          aws cloudfront wait invalidation-completed \
            --distribution-id ${{ steps.vars.outputs.CLOUDFRONT_DISTRIBUTION_ID }} \
            --id $INVALIDATION_ID
          echo "Invalidation completed!"

  # ===========================================
  # Job 3: Smoke Tests
  # ===========================================
  smoke-tests:
    name: Run Smoke Tests
    needs: deploy
    runs-on: ubuntu-latest

    steps:
      - name: Set site URL
        id: vars
        run: |
          if [ "${{ github.event.inputs.environment }}" == "staging" ]; then
            echo "SITE_URL=https://staging.mentalspaceehr.com" >> $GITHUB_OUTPUT
          else
            echo "SITE_URL=https://www.mentalspaceehr.com" >> $GITHUB_OUTPUT
          fi

      - name: Wait for deployment to propagate
        run: sleep 10

      - name: Test homepage loads
        run: |
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.vars.outputs.SITE_URL }})
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Homepage returned HTTP $HTTP_STATUS"
            exit 1
          fi
          echo "Homepage returned HTTP 200 OK"

      - name: Test login page loads
        run: |
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.vars.outputs.SITE_URL }}/login)
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Login page returned HTTP $HTTP_STATUS"
            exit 1
          fi
          echo "Login page returned HTTP 200 OK"

      - name: Verify correct application is deployed
        run: |
          TITLE=$(curl -s ${{ steps.vars.outputs.SITE_URL }} | grep -o '<title>[^<]*</title>' | head -1)
          echo "Page title: $TITLE"
          if [[ "$TITLE" != *"EHR"* ]] && [[ "$TITLE" != *"MentalSpace Therapy"* ]]; then
            echo "ERROR: Wrong application deployed! Expected MentalSpace EHR but got: $TITLE"
            exit 1
          fi
          echo "Correct application verified!"

  # ===========================================
  # Job 4: Deployment Summary
  # ===========================================
  summary:
    name: Deployment Summary
    needs: [build, deploy, smoke-tests]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Set variables
        id: vars
        run: |
          if [ "${{ github.event.inputs.environment }}" == "staging" ]; then
            echo "SITE_URL=https://staging.mentalspaceehr.com" >> $GITHUB_OUTPUT
            echo "ENV_NAME=Staging" >> $GITHUB_OUTPUT
          else
            echo "SITE_URL=https://www.mentalspaceehr.com" >> $GITHUB_OUTPUT
            echo "ENV_NAME=Production" >> $GITHUB_OUTPUT
          fi

      - name: Create summary
        run: |
          echo "## Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '✅ Success' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result == 'success' && '✅ Success' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result == 'success' && '✅ Success' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.vars.outputs.ENV_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.vars.outputs.SITE_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
