// MentalSpace EHR V2 - Prisma Schema
// Based on comprehensive PRD documentation

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// PHASE 1: USER MANAGEMENT & AUTHENTICATION
// ============================================================================

enum UserRole {
  SUPER_ADMIN // Absolute access to everything - bypasses all authorization checks
  ADMINISTRATOR
  SUPERVISOR
  CLINICIAN
  BILLING_STAFF
  FRONT_DESK
  ASSOCIATE
}

// Module 9: Staff Management Enums
enum EmploymentStatus {
  ACTIVE
  ON_LEAVE
  TERMINATED
  SUSPENDED
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
  INTERN
  PER_DIEM
}

model User {
  id            String     @id @default(uuid())
  email         String     @unique
  password      String // bcrypt hashed
  firstName     String
  middleName    String?
  lastName      String
  suffix        String?
  preferredName String?
  roles         UserRole[] // Multiple roles support

  // Professional Information
  title             String? // PhD, PsyD, LCSW, etc.
  licenseNumber     String?
  licenseState      String?
  licenseExpiration DateTime?
  npiNumber         String?
  deaNumber         String?
  taxonomyCode      String?

  // Professional Information
  specialties     String[]
  languagesSpoken String[]

  // Client-Facing Profile (for portal)
  profileBio          String?
  profilePhotoS3      String? // S3 URL for profile photo
  yearsOfExperience   Int?
  education           String[] // Array of degrees ["PhD in Clinical Psychology, Harvard 2015", "MA in Psychology, UCLA 2010"]
  approachesToTherapy String[] // ["CBT", "DBT", "EMDR", "Psychodynamic"]
  treatmentPhilosophy String?

  // Supervision
  isUnderSupervision        Boolean   @default(false)
  supervisorId              String?
  supervisor                User?     @relation("Supervision", fields: [supervisorId], references: [id])
  supervisees               User[]    @relation("Supervision")
  supervisionStartDate      DateTime?
  supervisionEndDate        DateTime?
  requiredSupervisionHours  Int?
  completedSupervisionHours Float?

  isSupervisor        Boolean  @default(false)
  supervisionLicenses String[]

  // Contact
  phoneNumber           String?
  officeExtension       String?
  personalEmail         String?
  emergencyContactName  String?
  emergencyContactPhone String?

  // Practice Settings
  defaultOfficeLocation  String?
  availableForScheduling Boolean @default(true)
  acceptsNewClients      Boolean @default(true)

  // Notifications
  emailNotifications   Boolean @default(true)
  smsNotifications     Boolean @default(false)
  appointmentReminders Boolean @default(true)
  noteReminders        Boolean @default(true)
  supervisoryAlerts    Boolean @default(true)

  // Billing
  defaultRate       Decimal? @db.Decimal(10, 2)
  hourlyPayrollRate Decimal? @db.Decimal(10, 2)
  taxId             String?

  // Account Status
  isActive      Boolean   @default(true)
  mfaEnabled    Boolean   @default(false)
  lastLoginDate DateTime?

  // Password Management
  mustChangePassword     Boolean   @default(false)
  passwordResetToken     String?   @unique
  passwordResetExpiry    DateTime?
  emailVerified          Boolean   @default(true) // Default true for staff (manual creation)
  emailVerificationToken String?   @unique
  invitationSentAt       DateTime?
  invitationToken        String?   @unique

  // Signature
  digitalSignature String? // base64
  signatureDate    DateTime?

  // Phase 1.4: Signature Authentication
  signaturePin       String? // Encrypted 4-6 digit PIN
  signaturePassword  String? // Separate from login password (hashed)
  signatureBiometric String? // Fingerprint hash (future)

  // Module 9: Staff Management - Employment Information
  employeeId       String?           @unique
  hireDate         DateTime?
  terminationDate  DateTime?
  employmentStatus EmploymentStatus? @default(ACTIVE)
  department       String?
  jobTitle         String?
  workLocation     String?
  employmentType   EmploymentType?

  // Module 9: Organizational Structure
  managerId    String?
  manager      User?   @relation("ManagerSubordinates", fields: [managerId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  subordinates User[]  @relation("ManagerSubordinates")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clinicalNotesCreated    ClinicalNote[]        @relation("NoteCreator")
  clinicalNotesCosigned   ClinicalNote[]        @relation("NoteCosigner")
  appointmentsAsClinician Appointment[]         @relation("AppointmentClinician")
  supervisionSessions     SupervisionSession[]  @relation("SupervisionSessionSupervisor")
  superviseeSessions      SupervisionSession[]  @relation("SupervisionSessionSupervisee")
  supervisionHoursLogs    SupervisionHoursLog[]
  clientsAsTherapist      Client[]              @relation("ClientTherapist")

  // Productivity Module Relations (Phase 6)
  productivityMetrics ProductivityMetric[] @relation("ProductivityMetrics")
  alertsAsTarget      ComplianceAlert[]    @relation("AlertTarget")
  alertsAsSupervisor  ComplianceAlert[]    @relation("AlertSupervisor")
  alertsAsAdmin       ComplianceAlert[]    @relation("AlertAdmin")
  performanceGoals    PerformanceGoal[]    @relation("PerformanceGoals")

  // Phase 1.4: Electronic Signatures
  signatureEvents SignatureEvent[] @relation("UserSignatureEvents")

  // Phase 1.5: Amendment History
  amendments      NoteAmendment[] @relation("UserAmendments")
  versionsCreated NoteVersion[]   @relation("VersionCreator")

  // Client Portal Integration (Phase 9) - Therapist/Admin interactions
  sessionReviewsReceived      SessionReview[]          @relation("SessionReviewClinician")
  therapistChangeRequestsFrom TherapistChangeRequest[] @relation("ChangeRequestCurrentClinician")
  therapistChangeRequestsTo   TherapistChangeRequest[] @relation("ChangeRequestNewClinician")
  dailyPromptsCreated         DailyPrompt[]            @relation("DailyPromptCreator")
  resourcesCreated            Resource[]               @relation("ResourceCreator")
  resourceAssignments         ResourceAssignment[]     @relation("ResourceAssigner")
  crisisToolkitsManaged       CrisisToolkit[]          @relation("CrisisToolkitManager")
  audioMessagesCreated        AudioMessage[]           @relation("AudioMessageCreator")
  homeworkAssigned            HomeworkAssignment[]     @relation("HomeworkAssigner")
  therapeuticGoalsCreated     TherapeuticGoal[]        @relation("GoalCreator")
  goalProgressUpdates         GoalProgressUpdate[]     @relation("GoalUpdater")
  winCommentsPosted           WinComment[]             @relation("WinCommenter")
  journalCommentsPosted       JournalComment[]         @relation("JournalCommenter")
  sessionSummariesCreated     SessionSummary[]         @relation("SessionSummaryCreator")
  scheduledCheckInsCreated    ScheduledCheckIn[]       @relation("CheckInCreator")

  // Clinical Notes Business Rules
  diagnosisHistoryEntries DiagnosisHistory[] @relation("DiagnosisHistoryUser")

  // Client Diagnoses Relations
  diagnosesCreated  ClientDiagnosis[] @relation("DiagnosedBy")
  diagnosesReviewed ClientDiagnosis[] @relation("LastReviewedBy")

  // Module 2: Client Relationships & Providers
  clientRelationshipsCreated ClientRelationship[] @relation("RelationshipCreator")
  clientProvidersAsInternal  ClientProvider[]     @relation("InternalProvider")
  clientProvidersCreated     ClientProvider[]     @relation("CreatedByUser")

  // Prior Authorization Relations (Module 2)
  priorAuthsRequested  PriorAuthorization[] @relation("RequestingProvider")
  priorAuthsPerforming PriorAuthorization[] @relation("PerformingProvider")
  priorAuthsCreated    PriorAuthorization[] @relation("AuthCreator")

  // Phase 1: Authentication & User Management - Security Features
  // Account Lockout
  failedLoginAttempts Int       @default(0)
  accountLockedUntil  DateTime?

  // Password Policies
  passwordChangedAt DateTime @default(now())
  passwordHistory   String[] @default([])

  // MFA (Optional)
  mfaSecret      String?
  mfaBackupCodes String[]  @default([])
  mfaMethod      String?
  mfaEnabledAt   DateTime?

  // Relations
  sessions           Session[]            @relation
  duplicatesReviewed PotentialDuplicate[] @relation("DuplicateReviewer")

  // Module 3 Phase 2: Group Appointments
  groupsAsFacilitator   GroupSession[] @relation("GroupFacilitator")
  groupsAsCoFacilitator GroupSession[] @relation("GroupCoFacilitator")
  screenedMembers       GroupMember[]

  // Module 3 Phase 2: Provider Availability & Time-Off
  availability       ProviderAvailability[]
  timeOffAsProvider  TimeOffRequest[]       @relation("TimeOffProvider")
  timeOffAsRequester TimeOffRequest[]       @relation("TimeOffRequester")
  timeOffAsApprover  TimeOffRequest[]       @relation("TimeOffApprover")
  timeOffAsCoverage  TimeOffRequest[]       @relation("TimeOffCoverage")

  // Module 3 Phase 4: AI Scheduling Assistant
  schedulingSuggestionsAsProvider          SchedulingSuggestion[]         @relation("SuggestionProvider")
  schedulingSuggestionsAsSuggestedProvider SchedulingSuggestion[]         @relation("SuggestedProvider")
  providerCompatibilityScores              ProviderClientCompatibility[]  @relation("CompatibilityProvider")
  schedulingPatternsAsProvider             SchedulingPattern[]            @relation("PatternProvider")
  schedulingPatternsAsResolver             SchedulingPattern[]            @relation("PatternResolver")
  nlpSchedulingLogs                        NaturalLanguageSchedulingLog[]

  // Module 4 Phase 2.3: Outcome Measures
  outcomeMeasuresAdministered OutcomeMeasure[] @relation("OutcomeMeasureAdministrator")

  // Module 7: Client Portal - Waitlist, Scheduling Rules, and Guardian Access
  waitlistEntriesAsClinician WaitlistEntry[]        @relation("ClinicianWaitlist")
  waitlistOffers             WaitlistOffer[]        @relation("ClinicianOffers")
  schedulingRules            SchedulingRule[]       @relation("ClinicianSchedulingRules")
  guardianRelationships      GuardianRelationship[] @relation("GuardianRelationships")

  // Module 8: Reporting & Analytics
  dashboards        Dashboard[]        @relation("UserDashboards")
  alerts            ThresholdAlert[]   @relation("UserAlerts")
  reportDefinitions ReportDefinition[] @relation("UserReports")
  reportVersions    ReportVersion[]    @relation("ReportVersions")
  schedules         ReportSchedule[]   @relation("UserSchedules")
  subscriptions     Subscription[]     @relation("UserSubscriptions")
  distributionLists DistributionList[] @relation("CreatedDistributionLists")

  // Module 9: Credentialing & Licensing (Agent 1)
  credentials Credential[] @relation("UserCredentials")

  // Module 9: Compliance Management (Agent 3)
  policiesOwned          Policy[]               @relation("PolicyOwner")
  policiesApproved       Policy[]               @relation("PolicyApprover")
  policyAcknowledgments  PolicyAcknowledgment[] @relation("PolicyAcknowledgments")
  incidentsReported      Incident[]             @relation("IncidentReporter")
  incidentsInvestigating Incident[]             @relation("IncidentInvestigator")

  // Module 9: Staff Management
  onboardingChecklist OnboardingChecklist?  @relation("UserOnboarding")
  mentees             OnboardingChecklist[] @relation("OnboardingMentor")

  // Module 9: Training & Development (Agent 2)
  trainingRecords TrainingRecord[] @relation("UserTrainingRecords")

  // Module 9: Communication & Document Management (Agent 6)
  messagesSent      Message[]        @relation("MessageSender")
  channelsCreated   Channel[]        @relation("ChannelCreator")
  documentsUploaded Document[]       @relation("DocumentUploader")
  foldersCreated    DocumentFolder[] @relation("FolderCreator")

  // Module 9: Vendor & Financial Administration (Agent 7)
  budgetsOwned            Budget[]        @relation("BudgetOwner")
  expensesSubmitted       Expense[]       @relation("ExpenseSubmitter")
  expensesApproved        Expense[]       @relation("ExpenseApprover")
  purchaseOrdersRequested PurchaseOrder[] @relation("PORequestor")
  purchaseOrdersApproved  PurchaseOrder[] @relation("POApprover")

  // Module 9: HR Functions - Performance Reviews, Time & Attendance, PTO (Agent 4)
  performanceReviewsAsReviewed PerformanceReview[] @relation("ReviewedUser")
  performanceReviewsAsReviewer PerformanceReview[] @relation("Reviewer")
  timeAttendanceRecords        TimeAttendance[]    @relation("TimeAttendanceUser")
  timeAttendanceAsApprover     TimeAttendance[]    @relation("AttendanceApprover")
  ptoRequests                  PTORequest[]        @relation("PTORequestor")
  ptoRequestsAsApprover        PTORequest[]        @relation("PTOApprover")
  ptoBalance                   PTOBalance?         @relation("PTOBalance")

  @@map("users")
}

// ============================================================================
// AUTHENTICATION & SESSION MANAGEMENT (Phase 1)
// ============================================================================

model Session {
  id            String   @id @default(uuid())
  userId        String
  token         String   @unique
  refreshToken  String?  @unique
  ipAddress     String
  userAgent     String
  deviceTrusted Boolean  @default(false)
  createdAt     DateTime @default(now())
  expiresAt     DateTime
  lastActivity  DateTime @default(now())
  isActive      Boolean  @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([token])
  @@map("sessions")
}

// ============================================================================
// MODULE 9: STAFF MANAGEMENT - ONBOARDING
// ============================================================================

model OnboardingChecklist {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation("UserOnboarding", fields: [userId], references: [id], onDelete: Cascade)

  // Checklist Items - Stored as JSON array of objects
  // Each item: { id: string, category: string, task: string, completed: boolean, completedAt: DateTime?, completedBy: string?, notes: string? }
  items Json @default("[]")

  // Onboarding Milestones
  startDate         DateTime
  firstDayComplete  Boolean  @default(false)
  firstWeekComplete Boolean  @default(false)
  thirtyDayComplete Boolean  @default(false)
  sixtyDayComplete  Boolean  @default(false)
  ninetyDayComplete Boolean  @default(false)

  // Completion Tracking
  completionDate       DateTime?
  completionPercentage Int       @default(0) // 0-100

  // Mentor Assignment
  mentorId String?
  mentor   User?   @relation("OnboardingMentor", fields: [mentorId], references: [id], onDelete: SetNull)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([mentorId])
  @@index([completionPercentage])
  @@map("onboarding_checklists")
}

// ============================================================================
// PRACTICE SETTINGS & CONFIGURATION
// ============================================================================

model PracticeSettings {
  id String @id @default(uuid())

  // General Practice Information
  practiceName       String
  practiceEmail      String
  practicePhone      String
  practiceWebsite    String?
  practiceLogo       String? // URL to logo image
  timezone           String   @default("America/New_York")
  businessHoursStart String   @default("09:00")
  businessHoursEnd   String   @default("17:00")
  businessDays       String[] @default(["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"])

  // Address
  addressStreet1 String
  addressStreet2 String?
  addressCity    String
  addressState   String
  addressZipCode String

  // Clinical Documentation Settings
  defaultNoteDueDays            Int     @default(3) // Days after session to complete note
  requireCosignForAssociates    Boolean @default(true)
  enableAutoLockout             Boolean @default(true) // Sunday lockout feature
  lockoutDay                    String  @default("Sunday")
  lockoutTime                   String  @default("23:59")
  enableNoteReminders           Boolean @default(true)
  noteReminderSchedule          Int[]   @default([2, 1, 0]) // Days before due date
  allowLateNoteCompletion       Boolean @default(false)
  requireSignatureForCompletion Boolean @default(true)

  // Scheduling Settings
  defaultAppointmentDuration  Int      @default(50) // minutes
  enableOnlineBooking         Boolean  @default(false)
  enableWaitlist              Boolean  @default(true)
  enableRecurringAppointments Boolean  @default(true)
  cancellationNoticePeriod    Int      @default(24) // hours
  enableCancellationFees      Boolean  @default(false)
  cancellationFeeAmount       Decimal? @db.Decimal(10, 2)
  noShowFeeAmount             Decimal? @db.Decimal(10, 2)
  bufferBetweenAppointments   Int      @default(10) // minutes
  maxAdvanceBookingDays       Int      @default(90)

  // Billing Settings
  defaultCurrency               String   @default("USD")
  taxRate                       Decimal  @default(0) @db.Decimal(5, 2)
  enableInsuranceBilling        Boolean  @default(true)
  enableSelfPayBilling          Boolean  @default(true)
  requirePaymentAtTimeOfService Boolean  @default(false)
  acceptedPaymentMethods        String[] @default(["Cash", "Credit Card", "Check", "Insurance"])
  lateFeeEnabled                Boolean  @default(false)
  lateFeeAmount                 Decimal? @db.Decimal(10, 2)
  lateFeeDaysAfterDue           Int      @default(30)
  invoicePrefix                 String   @default("INV")
  invoiceStartingNumber         Int      @default(1000)

  // Compliance Settings
  hipaaComplianceEnabled Boolean @default(true)
  requireTwoFactorAuth   Boolean @default(false)
  passwordExpirationDays Int     @default(90)
  sessionTimeoutMinutes  Int     @default(30)
  enableAuditLogging     Boolean @default(true)
  dataRetentionYears     Int     @default(7)
  enableAutoBackup       Boolean @default(true)
  backupFrequency        String  @default("Daily") // Daily, Weekly, Monthly
  requireConsentForms    Boolean @default(true)
  enableClientPortal     Boolean @default(true)

  // Telehealth Settings
  enableTelehealth              Boolean @default(true)
  telehealthPlatform            String  @default("Built-in") // Built-in, Zoom, etc.
  requireConsentForTelehealth   Boolean @default(true)
  recordTelehealthSessions      Boolean @default(false)
  telehealthRecordingDisclosure String?

  // Supervision Settings
  enableSupervision           Boolean @default(true)
  requiredSupervisionHours    Int     @default(3000)
  supervisionSessionFrequency String  @default("Weekly") // Weekly, Biweekly, Monthly
  enableGroupSupervision      Boolean @default(true)
  enableTriadicSupervision    Boolean @default(true)

  // AI Integration Settings
  enableAIFeatures             Boolean @default(false)
  aiProvider                   String? // "OpenAI", "Anthropic", "Custom"
  aiModel                      String? // "gpt-4", "claude-3", etc.
  // DEPRECATED: Do not store API keys in database. Use AWS Secrets Manager instead.
  // This field is kept only for backward compatibility and should remain NULL.
  aiApiKey                     String? // DEPRECATED - Use Secrets Manager
  enableAINoteGeneration       Boolean @default(false)
  enableAITreatmentSuggestions Boolean @default(false)
  enableAIScheduling           Boolean @default(false)
  enableAIDiagnosisAssistance  Boolean @default(false)
  aiConfidenceThreshold        Decimal @default(0.8) @db.Decimal(3, 2)
  requireHumanReview           Boolean @default(true)
  aiUsageLogging               Boolean @default(true)

  // Email Notification Settings
  smtpHost                   String?
  smtpPort                   Int?
  smtpSecure                 Boolean @default(true)
  smtpUser                   String?
  // DEPRECATED: Do not store passwords in database. Use AWS Secrets Manager instead.
  // This field is kept only for backward compatibility and should remain NULL.
  smtpPass                   String? // DEPRECATED - Use Secrets Manager
  emailFromName              String?
  emailFromAddress           String?
  enableAppointmentReminders Boolean @default(true)
  enableBillingReminders     Boolean @default(true)
  enableSystemNotifications  Boolean @default(true)

  // Client Portal Settings
  portalRequireEmailVerification Boolean @default(true)
  portalEnableAppointmentBooking Boolean @default(true)
  portalEnableBilling            Boolean @default(true)
  portalEnableMessaging          Boolean @default(true)
  portalEnableDocuments          Boolean @default(true)
  portalEnableMoodTracking       Boolean @default(true)
  portalEnableAssessments        Boolean @default(true)

  // Reporting Settings
  enableProductivityReports  Boolean @default(true)
  enableFinancialReports     Boolean @default(true)
  enableComplianceReports    Boolean @default(true)
  reportDistributionEmail    String?
  autoGenerateMonthlyReports Boolean @default(false)

  // Feature Flags
  enableBetaFeatures      Boolean @default(false)
  enableExperimentalAI    Boolean @default(false)
  enableAdvancedAnalytics Boolean @default(false)

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  lastModifiedBy String

  // Module 3: Reminder Configuration Relation
  reminderConfig ReminderConfiguration?

  @@map("practice_settings")
}

// ============================================================================
// PHASE 2: CLIENT MANAGEMENT & DEMOGRAPHICS
// ============================================================================

enum ClientStatus {
  ACTIVE
  INACTIVE
  DISCHARGED
  DECEASED
}

enum Gender {
  MALE
  FEMALE
  NON_BINARY
  OTHER
  PREFER_NOT_TO_SAY
}

model Client {
  id                  String @id @default(uuid())
  medicalRecordNumber String @unique

  // Personal Information
  firstName     String
  middleName    String?
  lastName      String
  suffix        String?
  previousNames String[]
  preferredName String?
  pronouns      String?

  // Date of Birth
  dateOfBirth DateTime

  // Contact Information
  primaryPhone           String
  primaryPhoneType       String  @default("Mobile")
  secondaryPhone         String?
  secondaryPhoneType     String?
  email                  String?
  preferredContactMethod String  @default("Phone")
  okayToLeaveMessage     Boolean @default(true)

  // Address
  addressStreet1     String
  addressStreet2     String?
  addressCity        String
  addressState       String
  addressZipCode     String
  addressCounty      String?
  isTemporaryAddress Boolean   @default(false)
  temporaryUntil     DateTime?

  // Mailing Address (if different)
  mailingStreet1 String?
  mailingStreet2 String?
  mailingCity    String?
  mailingState   String?
  mailingZipCode String?

  // Demographics
  gender              Gender
  genderIdentity      String?
  sexAssignedAtBirth  String?
  sexualOrientation   String?
  maritalStatus       String?
  race                String[]
  ethnicity           String?
  primaryLanguage     String   @default("English")
  otherLanguages      String[]
  needsInterpreter    Boolean  @default(false)
  interpreterLanguage String?
  religion            String?

  // Social Information
  education         String?
  employmentStatus  String?
  occupation        String?
  employer          String?
  livingArrangement String?
  housingStatus     String?

  // Veteran Status
  isVeteran             Boolean @default(false)
  militaryBranch        String?
  militaryDischargeType String?

  // Legal
  legalStatus          String?
  guardianName         String?
  guardianPhone        String?
  guardianRelationship String?

  // Account Status
  status           ClientStatus @default(ACTIVE)
  statusDate       DateTime     @default(now())
  registrationDate DateTime     @default(now())
  dischargeDate    DateTime?
  dischargeReason  String?
  deceasedDate     DateTime?

  // Assignment
  primaryTherapistId String
  primaryTherapist   User    @relation("ClientTherapist", fields: [primaryTherapistId], references: [id])
  psychiatristId     String?
  caseManagerId      String?

  // Consents
  treatmentConsent         Boolean   @default(false)
  treatmentConsentDate     DateTime?
  hipaaAcknowledgment      Boolean   @default(false)
  hipaaAcknowledgmentDate  DateTime?
  releaseOfInformation     Boolean   @default(false)
  releaseOfInformationDate DateTime?
  electronicCommunication  Boolean   @default(false)
  appointmentReminders     Boolean   @default(true)
  photographyConsent       Boolean   @default(false)

  // Special Needs
  specialNeeds       String?
  accessibilityNeeds String[]
  allergyAlerts      String[]

  // Previous System
  previousMRN        String?
  previousSystemName String?

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  lastModifiedBy String

  // Relations
  emergencyContacts   EmergencyContact[]
  legalGuardians      LegalGuardian[]
  insuranceInfo       InsuranceInformation[]
  priorAuthorizations PriorAuthorization[]
  appointments        Appointment[]
  clinicalNotes       ClinicalNote[]
  treatmentPlans      TreatmentPlan[]
  diagnoses           Diagnosis[]
  clientDiagnoses     ClientDiagnosis[]
  medications         Medication[]
  documents           ClientDocument[]
  charges             ChargeEntry[]
  payments            PaymentRecord[]
  statements          ClientStatement[]
  portalAccount       PortalAccount?
  telehealthConsents  TelehealthConsent[]
  sessionRatings      SessionRating[]        @relation("ClientSessionRatings")

  // Client Portal Relations (Phase 9) - Client-generated data visible to therapist
  insuranceCards          InsuranceCard[]
  paymentMethods          PaymentMethod[]
  formAssignments         FormAssignment[]
  sessionReviews          SessionReview[]          @relation("SessionReviewClient")
  therapistChangeRequests TherapistChangeRequest[] @relation("ChangeRequestClient")
  moodEntries             MoodEntry[]              @relation("ClientMoodEntry")
  symptomTrackers         ClientSymptomTracker[]   @relation("ClientSymptomTracker")
  dailyPrompts            DailyPrompt[]            @relation("ClientDailyPrompt")
  promptResponses         PromptResponse[]         @relation("ClientPromptResponse")
  engagementStreak        EngagementStreak?        @relation("ClientStreak")
  milestones              Milestone[]              @relation("ClientMilestone")
  preSessionPreps         PreSessionPrep[]         @relation("ClientPreSessionPrep")
  resourceAssignments     ResourceAssignment[]     @relation("ClientResourceAssignment")
  crisisToolkit           CrisisToolkit?           @relation("ClientCrisisToolkit")
  crisisToolkitUsage      CrisisToolkitUsage[]     @relation("ClientCrisisUsage")
  audioMessages           AudioMessage[]           @relation("ClientAudioMessage")
  audioPlayLogs           AudioPlayLog[]           @relation("ClientAudioPlayLog")
  homeworkAssignments     HomeworkAssignment[]     @relation("ClientHomework")
  therapeuticGoals        TherapeuticGoal[]        @relation("ClientGoal")
  winEntries              WinEntry[]               @relation("ClientWinEntry")
  copingSkillLogs         CopingSkillLog[]         @relation("ClientCopingSkillLog")
  scheduledCheckIns       ScheduledCheckIn[]       @relation("ClientScheduledCheckIn")
  reminderNudges          ReminderNudge[]          @relation("ClientReminderNudge")
  microContentDeliveries  MicroContentDelivery[]   @relation("ClientMicroContent")
  journalEntries          JournalEntry[]           @relation("ClientJournalEntry")
  sessionSummaries        SessionSummary[]         @relation("ClientSessionSummary")

  // Module 2: Client Relationships & Providers
  relationshipsAsClient1 ClientRelationship[] @relation("Client1Relationships")
  relationshipsAsClient2 ClientRelationship[] @relation("Client2Relationships")
  providers              ClientProvider[]

  // Module 2: Duplicate Detection
  duplicatesAsClient1 PotentialDuplicate[] @relation("Client1Duplicates")
  duplicatesAsClient2 PotentialDuplicate[] @relation("Client2Duplicates")
  mergedIntoId        String?              @db.Uuid
  mergedAt            DateTime?
  isMerged            Boolean              @default(false)

  // Module 3 Phase 2: Group Appointments
  groupMemberships GroupMember[]

  // Module 3 Phase 4: AI Scheduling Assistant
  schedulingSuggestions SchedulingSuggestion[]
  compatibilityScores   ProviderClientCompatibility[]
  schedulingPatterns    SchedulingPattern[]

  // Module 4 Phase 2.3: Outcome Measures
  outcomeMeasures OutcomeMeasure[]

  // Module 7: Client Portal - Self-Tracking and Guardian Access
  waitlistEntries            WaitlistEntry[]        @relation("ClientWaitlist")
  symptomLogs                SymptomLog[]           @relation("ClientSymptomLogs")
  sleepLogs                  SleepLog[]             @relation("ClientSleepLogs")
  exerciseLogs               ExerciseLog[]          @relation("ClientExerciseLogs")
  guardianRelationships      GuardianRelationship[] @relation("MinorRelationships")
  medicationAdherenceRecords MedicationAdherence[]  @relation("ClientMedicationAdherence")

  @@map("clients")
}

model PotentialDuplicate {
  id              String    @id @default(uuid())
  client1Id       String
  client2Id       String
  matchType       String // EXACT, PHONETIC, FUZZY, PARTIAL_DOB, ADDRESS
  confidenceScore Float // 0.0 to 1.0
  matchFields     String[] // e.g., ['name', 'dob', 'phone']
  status          String // PENDING, MERGED, DISMISSED, NEEDS_REVIEW
  reviewedBy      String?
  reviewedAt      DateTime?
  resolutionNotes String?   @db.Text
  createdAt       DateTime  @default(now())

  client1  Client @relation("Client1Duplicates", fields: [client1Id], references: [id])
  client2  Client @relation("Client2Duplicates", fields: [client2Id], references: [id])
  reviewer User?  @relation("DuplicateReviewer", fields: [reviewedBy], references: [id])

  @@unique([client1Id, client2Id])
  @@index([status])
  @@index([confidenceScore])
  @@map("potential_duplicates")
}

model EmergencyContact {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  name                String
  relationship        String
  phone               String
  alternatePhone      String?
  email               String?
  address             String?
  isPrimary           Boolean @default(false)
  okayToDiscussHealth Boolean @default(false)
  okayToLeaveMessage  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("emergency_contacts")
}

model LegalGuardian {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  firstName    String
  lastName     String
  relationship String
  phoneNumber  String
  email        String?
  address      String?
  isPrimary    Boolean @default(false)
  notes        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("legal_guardians")
}

// ============================================================================
// PHASE 2: INSURANCE INFORMATION
// ============================================================================

model InsuranceInformation {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  rank               String // Primary, Secondary, Tertiary
  insuranceCompany   String
  insuranceCompanyId String?
  planName           String
  planType           String
  memberId           String
  groupNumber        String?

  effectiveDate   DateTime
  terminationDate DateTime?

  // Subscriber Info
  subscriberIsClient       Boolean   @default(true)
  subscriberFirstName      String?
  subscriberLastName       String?
  subscriberDOB            DateTime?
  subscriberSSN            String?
  relationshipToSubscriber String?
  subscriberEmployer       String?

  // Contact
  customerServicePhone  String?
  precertificationPhone String?
  providerPhone         String?

  // Coverage
  requiresReferral     Boolean  @default(false)
  requiresPriorAuth    Boolean  @default(false)
  mentalHealthCoverage Boolean  @default(true)
  copay                Decimal? @db.Decimal(10, 2)
  coinsurance          Int? // percentage
  deductible           Decimal? @db.Decimal(10, 2)
  deductibleMet        Decimal? @db.Decimal(10, 2)
  outOfPocketMax       Decimal? @db.Decimal(10, 2)
  outOfPocketMet       Decimal? @db.Decimal(10, 2)

  // Verification
  lastVerificationDate DateTime?
  lastVerifiedBy       String?
  verificationNotes    String?
  remainingSessions    Int?

  // Card Images
  frontCardImage String? // S3 URL
  backCardImage  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  authorizationsRequired Boolean              @default(false)
  priorAuthorizations    PriorAuthorization[]

  @@map("insurance_information")
}

// ============================================================================
// PHASE 2: CLIENT DIAGNOSES (Module 2)
// ============================================================================

model ClientDiagnosis {
  id       String @id @default(uuid())
  clientId String

  // Diagnosis Information
  diagnosisType     String // PRIMARY, SECONDARY, RULE_OUT, HISTORICAL, PROVISIONAL
  icd10Code         String? @db.VarChar(10)
  dsm5Code          String? @db.VarChar(10)
  diagnosisName     String  @db.VarChar(500)
  diagnosisCategory String? // Mood Disorders, Anxiety Disorders, etc.

  // Clinical Details
  severitySpecifier String? // MILD, MODERATE, SEVERE, EXTREME
  courseSpecifier   String? // IN_REMISSION, PARTIAL_REMISSION, RECURRENT, etc.
  onsetDate         DateTime?
  remissionDate     DateTime?

  // Provider Information
  dateDiagnosed    DateTime  @default(now())
  diagnosedById    String
  lastReviewedDate DateTime?
  lastReviewedById String?

  // Status
  status          String    @default("ACTIVE") // ACTIVE, RESOLVED, RULE_OUT_REJECTED
  dateResolved    DateTime?
  resolutionNotes String?   @db.Text

  // Clinical Notes
  supportingEvidence         String? @db.Text
  differentialConsiderations String? @db.Text

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client         Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  diagnosedBy    User   @relation("DiagnosedBy", fields: [diagnosedById], references: [id])
  lastReviewedBy User?  @relation("LastReviewedBy", fields: [lastReviewedById], references: [id])

  @@index([clientId])
  @@index([icd10Code])
  @@index([dsm5Code])
  @@index([status])
  @@index([diagnosisType])
  @@map("client_diagnoses")
}

// ============================================================================
// PHASE 3: SCHEDULING & APPOINTMENTS
// ============================================================================

enum AppointmentStatus {
  REQUESTED
  SCHEDULED
  CONFIRMED
  CHECKED_IN
  IN_SESSION
  COMPLETED
  NO_SHOW
  CANCELLED
  RESCHEDULED
}

model Appointment {
  id          String @id @default(uuid())
  clientId    String
  client      Client @relation(fields: [clientId], references: [id])
  clinicianId String
  clinician   User   @relation("AppointmentClinician", fields: [clinicianId], references: [id])

  // Date/Time
  appointmentDate DateTime
  startTime       String
  endTime         String
  duration        Int // minutes
  timezone        String   @default("America/New_York")

  // Details
  appointmentType  String
  serviceLocation  String
  officeLocationId String?
  room             String?

  // Status
  status            AppointmentStatus @default(SCHEDULED)
  statusUpdatedDate DateTime          @default(now())
  statusUpdatedBy   String

  // Cancellation
  cancellationDate       DateTime?
  cancellationReason     String?
  cancellationNotes      String?
  cancelledBy            String?
  cancellationFeeApplied Boolean   @default(false)

  // No Show
  noShowDate       DateTime?
  noShowFeeApplied Boolean   @default(false)
  noShowNotes      String?

  // Check-in/out
  checkedInTime  String?
  checkedInBy    String?
  checkedOutTime String?
  checkedOutBy   String?
  actualDuration Int?

  // Billing
  cptCode       String?
  icdCodes      String[]
  chargeAmount  Decimal? @db.Decimal(10, 2)
  billingStatus String   @default("Not Billed")

  // Reminders (Enhanced for Module 3 Phase 1)
  reminders AppointmentReminder[]

  // Keep existing flags for backward compatibility
  emailReminderSent Boolean   @default(false)
  emailReminderDate DateTime?
  smsReminderSent   Boolean   @default(false)
  smsReminderDate   DateTime?

  // New confirmation tracking (Module 3)
  confirmedAt        DateTime?
  confirmedBy        String? // USER, CLIENT_SMS, CLIENT_PORTAL, CLIENT_VOICE
  confirmationMethod String? // SMS_REPLY, PORTAL_CLICK, VOICE_RESPONSE, MANUAL

  // No-Show Risk Prediction (Module 3)
  noShowRiskScore   Float? // 0.0 to 1.0
  noShowRiskLevel   String? // LOW, MEDIUM, HIGH
  noShowRiskFactors String[] // ["history", "weather", "late_booking"]
  riskCalculatedAt  DateTime?

  // Appointment Type Enhancement (Module 3)
  appointmentTypeId  String?
  appointmentTypeObj AppointmentType? @relation(fields: [appointmentTypeId], references: [id])

  // Recurring
  isRecurring          Boolean   @default(false)
  recurrenceFrequency  String?
  recurrenceInterval   Int?
  recurrenceDaysOfWeek String[]
  recurrenceEndDate    DateTime?
  parentRecurrenceId   String?

  // Notes
  appointmentNotes String?
  clientNotes      String?

  // Telehealth
  telehealthLink     String?
  telehealthPlatform String?

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  lastModifiedBy String

  // Relations
  clinicalNotes     ClinicalNote[]
  telehealthSession TelehealthSession?

  // Client Portal Relations (Phase 9)
  sessionReview  SessionReview?
  preSessionPrep PreSessionPrep?
  sessionSummary SessionSummary?

  // Module 3: Scheduling Relations
  noShowPredictionLogs NoShowPredictionLog[]

  // Module 3 Phase 2: Group Appointments
  groupSessionId String?
  groupSession   GroupSession?     @relation("GroupSessions", fields: [groupSessionId], references: [id])
  isGroupSession Boolean           @default(false)
  attendance     GroupAttendance[]

  // Module 3 Phase 4: AI Scheduling Assistant - NLP Created Appointments
  nlpSchedulingLogs NaturalLanguageSchedulingLog[] @relation("NLPCreatedAppointment")

  // Module 4 Phase 2.3: Outcome Measures
  outcomeMeasures OutcomeMeasure[]

  @@map("appointments")
}

// Telehealth Session Management
enum TelehealthSessionStatus {
  SCHEDULED
  WAITING_ROOM
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

model TelehealthSession {
  id            String      @id @default(uuid())
  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id])

  // Amazon Chime SDK Meeting Info
  chimeMeetingId         String  @unique
  chimeExternalMeetingId String?
  chimeMeetingRegion     String?

  // Session URLs
  clinicianJoinUrl String
  clientJoinUrl    String

  // Meeting Credentials (stored as JSON for flexibility)
  meetingDataJson Json // Contains meeting data from Chime

  // Session Status
  status            TelehealthSessionStatus @default(SCHEDULED)
  statusUpdatedDate DateTime                @default(now())

  // Waiting Room
  clientInWaitingRoom  Boolean   @default(false)
  waitingRoomEnteredAt DateTime?
  sessionStartedAt     DateTime?
  sessionEndedAt       DateTime?

  // Participants
  clinicianAttendeeId String?
  clientAttendeeId    String?
  attendeeDataJson    Json? // Additional attendee information

  // Recording
  recordingEnabled   Boolean   @default(false)
  recordingConsent   Boolean   @default(false)
  recordingStartedAt DateTime?
  recordingStoppedAt DateTime?
  recordingS3Key     String? // S3 location of recording
  recordingUrl       String? // Presigned URL for playback

  // Session Metadata
  actualDuration  Int? // minutes
  endReason       String? // Normal, Technical Issues, Emergency, etc.
  technicalIssues String? // Log of any technical problems

  // Phase 2: AI Transcription
  transcriptionEnabled   Boolean   @default(false)
  transcriptionConsent   Boolean   @default(false)
  transcriptionStartedAt DateTime?
  transcriptionStoppedAt DateTime?
  transcriptionStatus    String? // PENDING, IN_PROGRESS, COMPLETED, FAILED, DISABLED
  transcriptionJobId     String? // AWS Transcribe job ID for tracking
  transcriptionError     String? // Error message if transcription fails

  // Relations
  transcripts SessionTranscript[] @relation("SessionTranscripts")
  rating      SessionRating?      @relation("SessionRating")

  // Compliance & Security
  hipaaAuditLog Json? // Audit trail for HIPAA compliance

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  lastModifiedBy String

  @@map("telehealth_sessions")
}

// Phase 2: AI Transcription - Session Transcript Model
model SessionTranscript {
  id        String            @id @default(uuid())
  sessionId String
  session   TelehealthSession @relation("SessionTranscripts", fields: [sessionId], references: [id], onDelete: Cascade)

  // Transcript Content
  speakerLabel String // CLINICIAN, CLIENT, or speaker_0, speaker_1 from AWS
  text         String @db.Text
  startTime    Float // Start time in seconds from session start
  endTime      Float // End time in seconds from session start
  confidence   Float // AWS Transcribe confidence score (0.0 to 1.0)

  // Metadata
  isPartial  Boolean @default(false) // True for interim results, false for final
  itemType   String  @default("pronunciation") // pronunciation, punctuation
  vocabulary String? // Custom vocabulary used (if any)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId])
  @@index([sessionId, startTime])
  @@map("session_transcripts")
}

// Client Session Ratings (Admin-Only View)
model SessionRating {
  id        String            @id @default(uuid())
  sessionId String            @unique
  session   TelehealthSession @relation("SessionRating", fields: [sessionId], references: [id], onDelete: Cascade)

  // Client Feedback
  clientId String
  client   Client @relation("ClientSessionRatings", fields: [clientId], references: [id])

  rating   Int     @db.SmallInt // 1-5 stars
  comments String? @db.Text // Optional feedback text

  // Metadata
  submittedAt DateTime @default(now())
  ipAddress   String? // For audit purposes

  @@index([sessionId])
  @@index([clientId])
  @@index([rating])
  @@map("session_ratings")
}

// Telehealth Consent Management (Georgia Compliance)
model TelehealthConsent {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  // Consent Details
  consentType    String // 'Georgia_Telehealth', 'HIPAA_Telehealth', 'Recording'
  consentVersion String    @default("1.0")
  consentText    String // Full text of consent
  consentGiven   Boolean   @default(false)
  consentDate    DateTime?
  consentMethod  String? // 'Electronic', 'Paper', 'Verbal'

  // Georgia-Specific Requirements
  patientRightsAcknowledged        Boolean @default(false)
  emergencyProtocolsUnderstood     Boolean @default(false)
  privacyRisksAcknowledged         Boolean @default(false)
  technologyRequirementsUnderstood Boolean @default(false)

  // Consent Withdrawal
  consentWithdrawn Boolean   @default(false)
  withdrawalDate   DateTime?
  withdrawalReason String?

  // Renewal (Annual requirement in Georgia)
  expirationDate  DateTime
  renewalRequired Boolean   @default(true)
  renewalDate     DateTime?

  // Signature
  clientSignature  String? // Electronic signature
  clientIPAddress  String?
  clientUserAgent  String?
  witnessName      String?
  witnessSignature String?

  // Audit Trail
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  lastModifiedBy String

  @@index([clientId, consentType, isActive])
  @@map("telehealth_consents")
}

// Clinician Schedule Management
model ClinicianSchedule {
  id          String @id @default(uuid())
  clinicianId String

  // Weekly schedule stored as JSON
  weeklyScheduleJson Json // {monday: DaySchedule, tuesday: DaySchedule, etc.}

  // Settings
  acceptNewClients              Boolean @default(true)
  maxAppointmentsPerDay         Int?
  maxAppointmentsPerWeek        Int?
  bufferTimeBetweenAppointments Int? // minutes

  // Available locations
  availableLocations String[]

  // Effective dates
  effectiveStartDate DateTime
  effectiveEndDate   DateTime?

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  lastModifiedBy String

  @@map("clinician_schedules")
}

// Schedule Exceptions (Time Off, Modified Hours, etc.)
model ScheduleException {
  id          String @id @default(uuid())
  clinicianId String

  exceptionType String // 'Time Off', 'Holiday', 'Conference', 'Training', 'Modified Hours', 'Emergency', 'Other'

  startDate DateTime
  endDate   DateTime
  startTime String?
  endTime   String?
  allDay    Boolean  @default(true)

  reason String
  notes  String?

  status       String    @default("Requested") // 'Requested', 'Approved', 'Denied'
  approvedBy   String?
  approvalDate DateTime?
  denialReason String?

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  lastModifiedBy String

  @@map("schedule_exceptions")
}

// Waitlist Management
model WaitlistEntry {
  id          String  @id @default(uuid())
  clientId    String
  client      Client  @relation("ClientWaitlist", fields: [clientId], references: [id], onDelete: Cascade)
  clinicianId String?
  clinician   User?   @relation("ClinicianWaitlist", fields: [clinicianId], references: [id])

  // Appointment preferences
  appointmentType String // 'INITIAL_CONSULTATION', 'FOLLOW_UP', 'THERAPY_SESSION'
  preferredDays   String[] // ['MONDAY', 'TUESDAY', 'WEDNESDAY']
  preferredTimes  String[] // ['MORNING', 'AFTERNOON', 'EVENING']

  // Priority and status
  priority Int            @default(0) // Higher numbers = higher priority
  status   WaitlistStatus @default(ACTIVE)
  joinedAt DateTime       @default(now())

  // Notifications
  notificationsSent Int       @default(0)
  lastNotifiedAt    DateTime?

  // Additional info
  notes     String?
  expiresAt DateTime?

  // Legacy fields for backward compatibility
  requestedClinicianId     String?
  alternateClinicianIds    String[]
  requestedAppointmentType String?
  addedDate                DateTime?
  addedBy                  String?
  notified                 Boolean   @default(false)
  notifiedDate             DateTime?
  notificationMethod       String?
  scheduledAppointmentId   String?
  scheduledDate            DateTime?

  // Module 3 Phase 2.2: Waitlist Automation Fields
  priorityScore       Float     @default(0.5)
  preferredProviderId String?
  insuranceId         String?
  maxWaitDays         Int?
  lastOfferDate       DateTime?
  offerCount          Int       @default(0)
  declinedOffers      Int       @default(0)
  autoMatchEnabled    Boolean   @default(true)
  lastNotification    DateTime?

  // Relations
  offers WaitlistOffer[] @relation("WaitlistOffers")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([clinicianId])
  @@index([status])
  @@index([priority])
  @@map("waitlist_entries")
}

// Module 7: Waitlist Offer Tracking
model WaitlistOffer {
  id              String        @id @default(uuid())
  waitlistEntryId String
  waitlistEntry   WaitlistEntry @relation("WaitlistOffers", fields: [waitlistEntryId], references: [id], onDelete: Cascade)

  // Offered slot details
  clinicianId     String
  clinician       User     @relation("ClinicianOffers", fields: [clinicianId], references: [id])
  appointmentDate DateTime
  startTime       String
  endTime         String
  appointmentType String

  // Offer management
  status      WaitlistOfferStatus @default(PENDING) // PENDING, ACCEPTED, DECLINED, EXPIRED
  offeredAt   DateTime            @default(now())
  expiresAt   DateTime // Offer deadline
  respondedAt DateTime?

  // Response details
  declineReason String?
  notes         String?

  // Match quality
  matchScore   Float    @default(0)
  matchReasons String[] // ['Preferred clinician', 'Preferred day', etc.]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([waitlistEntryId])
  @@index([clinicianId])
  @@index([status])
  @@index([expiresAt])
  @@map("waitlist_offers")
}

enum WaitlistOfferStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

// Module 7: Scheduling Rules for Client Portal
model SchedulingRule {
  id          String  @id @default(uuid())
  clinicianId String? // null means organization-wide rule
  clinician   User?   @relation("ClinicianSchedulingRules", fields: [clinicianId], references: [id])

  // Booking restrictions
  maxAdvanceBookingDays   Int @default(30) // How far in advance clients can book
  minNoticeHours          Int @default(24) // Minimum hours before appointment can be booked
  cancellationWindowHours Int @default(24) // Hours before appointment when cancellation not allowed

  // Day restrictions
  allowWeekends Boolean  @default(false)
  allowedDays   String[] // ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY']

  // Blockout periods
  blockoutPeriods Json? // [{startDate: '2025-12-24', endDate: '2025-12-26', reason: 'Holiday'}]

  // Slot configuration
  slotDuration         Int  @default(60) // Minutes per appointment slot
  bufferTime           Int  @default(0) // Minutes between appointments
  maxDailyAppointments Int?

  // Automation
  autoConfirm Boolean @default(false) // Auto-confirm or require clinician approval

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicianId])
  @@index([isActive])
  @@map("scheduling_rules")
}

// Appointment Reminder Settings (per clinician)
model ReminderSettings {
  id          String @id @default(uuid())
  clinicianId String @unique

  enabled Boolean @default(true)

  // Email reminders
  emailRemindersEnabled Boolean @default(true)
  emailReminderTimings  Int[] // hours before [24, 1]
  emailTemplate         String?

  // SMS reminders
  smsRemindersEnabled Boolean @default(false)
  smsReminderTimings  Int[] // hours before [24, 1]
  smsTemplate         String?

  requireConfirmation   Boolean @default(false)
  includeRescheduleLink Boolean @default(true)
  includeCancelLink     Boolean @default(true)
  includeTelehealthLink Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("reminder_settings")
}

// Service Codes (CPT Codes)
model ServiceCode {
  id String @id @default(uuid())

  code        String  @unique
  description String
  serviceType String // 'Therapy Intake', 'Therapy Session', 'Group Therapy', etc.
  category    String? // 'Therapy', 'Assessment', 'Consultation', etc.

  defaultDuration Int? // minutes
  defaultRate     Decimal? @db.Decimal(10, 2)

  isActive              Boolean @default(true)
  requiresAuthorization Boolean @default(false)

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String?
  lastModifiedBy String?

  @@map("service_codes")
}

// ============================================================================
// PHASE 4: CLINICAL DOCUMENTATION
// ============================================================================

enum NoteStatus {
  DRAFT
  SIGNED
  LOCKED
  PENDING_COSIGN
  COSIGNED
  RETURNED_FOR_REVISION
}

model ClinicalNote {
  id            String      @id @default(uuid())
  clientId      String
  client        Client      @relation(fields: [clientId], references: [id])
  clinicianId   String
  clinician     User        @relation("NoteCreator", fields: [clinicianId], references: [id])
  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id])

  noteType         String // SOAP, Intake, Treatment Plan, etc.
  sessionDate      DateTime
  sessionStartTime String?
  sessionEndTime   String?
  sessionDuration  Int? // minutes

  // SOAP Note Fields
  subjective String?
  objective  String?
  assessment String?
  plan       String?

  // Risk Assessment
  suicidalIdeation      Boolean @default(false)
  suicidalPlan          Boolean @default(false)
  homicidalIdeation     Boolean @default(false)
  selfHarm              Boolean @default(false)
  riskLevel             String?
  riskAssessmentDetails String?
  interventionsTaken    String?

  // Diagnosis
  diagnosisCodes String[] // ICD-10 codes

  // Treatment
  interventionsUsed   String[]
  progressTowardGoals String?

  // Next Session
  nextSessionPlan String?
  nextSessionDate DateTime?

  // Status & Signatures
  status     NoteStatus @default(DRAFT)
  signedDate DateTime?
  signedBy   String?
  lockedDate DateTime?
  lockReason String?

  // Supervision/Co-signing
  requiresCosign     Boolean   @default(false)
  cosignedDate       DateTime?
  cosignedBy         String?
  cosigner           User?     @relation("NoteCosigner", fields: [cosignedBy], references: [id])
  supervisorComments String?

  // Revision Workflow (Phase 1.2)
  revisionHistory                Json[]   @default([]) // Array of {date, returnedBy, comments, requiredChanges, resolvedDate, resubmittedDate}
  revisionCount                  Int      @default(0)
  currentRevisionComments        String? // Current active revision comments
  currentRevisionRequiredChanges String[] @default([]) // Current active required changes list

  // Compliance
  dueDate         DateTime
  completedOnTime Boolean  @default(false)
  daysToComplete  Int?

  // Sunday Lockout & Unlock Requests
  isLocked           Boolean   @default(false)
  unlockRequested    Boolean   @default(false)
  unlockRequestDate  DateTime?
  unlockReason       String?
  unlockApprovedBy   String?
  unlockApprovalDate DateTime?
  unlockUntil        DateTime?

  // Billing
  cptCode     String?
  billingCode String?
  billable    Boolean @default(true)

  // AI Generated
  aiGenerated     Boolean @default(false)
  aiModel         String?
  aiPrompt        String?
  inputTranscript String?

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  lastModifiedBy String

  // Clinical Notes Business Rules Relations
  diagnosesCreated        Diagnosis[]             @relation("DiagnosisOriginNote")
  diagnosesLastUpdated    Diagnosis[]             @relation("DiagnosisLastUpdatedNote")
  diagnosisHistoryEntries DiagnosisHistory[]
  clinicalNoteDiagnoses   ClinicalNoteDiagnosis[]

  // Phase 1.4: Electronic Signatures
  signatureEvents SignatureEvent[] @relation("NoteSignatureEvents")

  // Phase 1.5: Amendment History
  amendments   NoteAmendment[] @relation("NoteAmendments")
  versions     NoteVersion[]   @relation("NoteVersions")
  billingHolds BillingHold[]

  // Phase 2.3: Outcome Measures
  outcomeMeasures OutcomeMeasure[]

  // Unique constraint: One note per appointment per note type
  @@unique([appointmentId, noteType])
  @@map("clinical_notes")
}

// ============================================================================
// PHASE 1.3: REQUIRED FIELD VALIDATION ENGINE
// ============================================================================

model NoteValidationRule {
  id String @id @default(uuid())

  noteType          String // Which note type this rule applies to
  fieldName         String // Name of the field being validated
  isRequired        Boolean @default(false) // Whether field is required
  minLength         Int? // Minimum length for text fields
  maxLength         Int? // Maximum length for text fields
  validationPattern String? // Regex pattern for validation
  errorMessage      String? // Custom error message

  // Conditional requirements
  conditionalOn    String? // Field name that this depends on
  conditionalValue String? // Value that conditionalOn must have

  // Metadata
  displayLabel    String? // User-friendly label for UI
  helpText        String? // Help text for users
  validationOrder Int     @default(0) // Order in which to validate

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String?
  lastModifiedBy String?

  @@unique([noteType, fieldName])
  @@map("note_validation_rules")
}

model TreatmentPlan {
  id          String @id @default(uuid())
  clientId    String
  client      Client @relation(fields: [clientId], references: [id])
  clinicianId String

  planDate       DateTime  @default(now())
  reviewDate     DateTime?
  nextReviewDate DateTime

  // Presenting Problems
  presentingProblems String[]

  // Goals (stored as JSON)
  goalsJson Json // Array of goal objects

  // Interventions
  interventions     String[]
  frequency         String
  estimatedDuration String

  // Discharge Criteria
  dischargeCriteria String?

  // Status
  status String @default("Active")

  // Signatures
  clinicianSignature String?
  clinicianSignDate  DateTime?
  clientSignature    String?
  clientSignDate     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("treatment_plans")
}

model Diagnosis {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  icdCode              String
  diagnosisDescription String
  diagnosisType        String    @default("Primary")
  onsetDate            DateTime?
  resolvedDate         DateTime?
  status               String    @default("Active")
  notes                String?

  diagnosedBy   String
  diagnosisDate DateTime @default(now())

  // Clinical Notes Business Rules - Track diagnosis origin and changes
  specifiers            String?
  severity              String? // e.g., 'Mild', 'Moderate', 'Severe'
  diagnosisNoteId       String?
  diagnosisNote         ClinicalNote? @relation("DiagnosisOriginNote", fields: [diagnosisNoteId], references: [id], onDelete: SetNull)
  createdInNoteType     String? // Note type where diagnosis was created
  lastUpdatedInNoteType String? // Note type where diagnosis was last updated
  lastUpdatedNoteId     String?
  lastUpdatedNote       ClinicalNote? @relation("DiagnosisLastUpdatedNote", fields: [lastUpdatedNoteId], references: [id], onDelete: SetNull)

  // Relations
  history               DiagnosisHistory[]
  clinicalNoteDiagnoses ClinicalNoteDiagnosis[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("diagnoses")
}

model Medication {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  medicationName String
  dosage         String
  frequency      String
  route          String
  prescribedBy   String
  prescribedDate DateTime
  startDate      DateTime
  endDate        DateTime?

  status             String    @default("Active")
  discontinuedDate   DateTime?
  discontinuedReason String?

  instructions String?
  sideEffects  String?
  notes        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("medications")
}

// Diagnosis History - Audit trail for diagnosis changes (Clinical Notes Business Rule #3)
model DiagnosisHistory {
  id                String        @id @default(uuid())
  diagnosisId       String
  diagnosis         Diagnosis     @relation(fields: [diagnosisId], references: [id], onDelete: Cascade)
  changedBy         String
  changedByUser     User          @relation("DiagnosisHistoryUser", fields: [changedBy], references: [id], onDelete: Restrict)
  changedInNoteId   String?
  changedInNote     ClinicalNote? @relation(fields: [changedInNoteId], references: [id], onDelete: SetNull)
  changedInNoteType String? // Note type where change occurred
  changeType        String // 'CREATED', 'MODIFIED', 'STATUS_CHANGE', 'DELETED'
  oldValues         Json? // Previous values as JSON
  newValues         Json? // New values as JSON
  changeReason      String?
  changedAt         DateTime      @default(now())

  @@index([diagnosisId])
  @@index([changedAt])
  @@map("diagnosis_history")
}

// Clinical Note Diagnoses - Link diagnoses to notes for billing (Clinical Notes Business Rule #3)
model ClinicalNoteDiagnosis {
  id           String       @id @default(uuid())
  noteId       String
  note         ClinicalNote @relation(fields: [noteId], references: [id], onDelete: Cascade)
  diagnosisId  String
  diagnosis    Diagnosis    @relation(fields: [diagnosisId], references: [id], onDelete: Cascade)
  pointerOrder Int          @default(1) // Billing pointer order (1, 2, 3, 4)
  createdAt    DateTime     @default(now())

  @@unique([noteId, diagnosisId])
  @@index([noteId])
  @@index([diagnosisId])
  @@map("clinical_note_diagnoses")
}

// ============================================================================
// PHASE 2.3: OUTCOME MEASURES INTEGRATION
// ============================================================================

enum OutcomeMeasureType {
  PHQ9 // Patient Health Questionnaire-9 (Depression)
  GAD7 // Generalized Anxiety Disorder-7
  PCL5 // PTSD Checklist for DSM-5
}

enum OutcomeSeverity {
  MINIMAL
  MILD
  MODERATE
  MODERATELY_SEVERE
  SEVERE
}

model OutcomeMeasure {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Administration details
  measureType      OutcomeMeasureType
  administeredById String
  administeredBy   User               @relation("OutcomeMeasureAdministrator", fields: [administeredById], references: [id])
  administeredDate DateTime           @default(now())

  // Clinical note association (optional - can be standalone or linked to a note)
  clinicalNoteId String?
  clinicalNote   ClinicalNote? @relation(fields: [clinicalNoteId], references: [id], onDelete: SetNull)

  // Appointment association (optional)
  appointmentId String?
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)

  // Responses stored as JSON
  // Format: { "q1": 2, "q2": 1, "q3": 3, ... }
  // Each question number maps to the selected response value
  responses Json

  // Scoring
  totalScore    Int
  severity      OutcomeSeverity
  severityLabel String // "Minimal depression", "Moderate anxiety", etc.

  // Clinical interpretation
  clinicalNotes String? // Clinician's notes about the results

  // Metadata
  completionTime Int? // Time taken to complete in seconds
  wasCompleted   Boolean @default(true) // False if partially completed

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([measureType])
  @@index([administeredDate])
  @@index([clinicalNoteId])
  @@map("outcome_measures")
}

// ============================================================================
// PHASE 5: SUPERVISION
// ============================================================================

model SupervisionSession {
  id           String @id @default(uuid())
  supervisorId String
  supervisor   User   @relation("SupervisionSessionSupervisor", fields: [supervisorId], references: [id])
  superviseeId String
  supervisee   User   @relation("SupervisionSessionSupervisee", fields: [superviseeId], references: [id])

  sessionDate      DateTime
  sessionStartTime String
  sessionEndTime   String
  sessionDuration  Int // minutes

  sessionType   String // Individual, Group, Triadic
  sessionFormat String // In-Person, Virtual, Phone

  // Content
  casesDiscussedJson Json // Array of cases
  topicsCovered      String[]
  skillsDeveloped    String[]

  feedbackProvided    String
  areasOfStrength     String[]
  areasForImprovement String[]

  actionItemsJson Json // Array of action items

  nextSessionScheduled Boolean   @default(false)
  nextSessionDate      DateTime?

  // Hours Credit
  hoursEarned Float
  hourType    String // Direct, Indirect, Group

  // Signatures
  supervisorSignature  String
  supervisorSignDate   DateTime
  superviseeSignature  String
  superviseeSignDate   DateTime
  superviseeReflection String?

  // Georgia Compliance (Phase 6 - Productivity Module)
  notesSigned   Boolean   @default(false)
  notesSignedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("supervision_sessions")
}

model SupervisionHoursLog {
  id           String @id @default(uuid())
  superviseeId String
  supervisee   User   @relation(fields: [superviseeId], references: [id])
  supervisorId String

  hourDate    DateTime
  hourType    String
  hoursEarned Float

  sessionDescription String
  topicsCovered      String[]

  verifiedBySupervisor       Boolean   @default(false)
  supervisorVerificationDate DateTime?
  supervisorSignature        String?

  appliesTo String // License requirement
  status    String @default("Pending")

  createdAt DateTime @default(now())
  createdBy String

  @@map("supervision_hours_log")
}

// ============================================================================
// PHASE 7: CLIENT PORTAL
// ============================================================================

enum PortalAccountStatus {
  ACTIVE
  INACTIVE
  LOCKED
  PENDING_VERIFICATION
}

enum WaitlistStatus {
  ACTIVE
  MATCHED
  CANCELLED
  EXPIRED
}

model PortalAccount {
  id       String @id @default(uuid())
  clientId String @unique
  client   Client @relation(fields: [clientId], references: [id])

  email      String  @unique
  password   String // hashed
  mfaEnabled Boolean @default(false)
  mfaMethod  String?

  accountStatus     PortalAccountStatus @default(PENDING_VERIFICATION)
  emailVerified     Boolean             @default(false)
  verificationToken String?

  // Password Reset
  passwordResetToken       String?
  passwordResetTokenExpiry DateTime?

  lastLoginDate       DateTime?
  failedLoginAttempts Int       @default(0)
  accountLockedUntil  DateTime?

  // Preferences
  emailNotifications   Boolean @default(true)
  smsNotifications     Boolean @default(false)
  appointmentReminders Boolean @default(true)
  billingReminders     Boolean @default(true)
  messageNotifications Boolean @default(true)

  portalAccessGranted Boolean   @default(false)
  grantedBy           String?
  grantedDate         DateTime?

  isGuardianAccount Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("portal_accounts")
}

// Client Portal - Intake Forms
model IntakeForm {
  id String @id @default(uuid())

  formName        String
  formDescription String?
  formType        String // 'Initial_Intake', 'Annual_Update', 'Symptom_Checklist', 'Custom'

  // Form Structure (stored as JSON)
  formFieldsJson Json // Array of field definitions

  isActive             Boolean @default(true)
  isRequired           Boolean @default(false)
  assignedToNewClients Boolean @default(false)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  lastModifiedBy String

  submissions IntakeFormSubmission[]
  assignments FormAssignment[]

  @@map("intake_forms")
}

model IntakeFormSubmission {
  id       String     @id @default(uuid())
  formId   String
  form     IntakeForm @relation(fields: [formId], references: [id])
  clientId String

  // Form Responses (stored as JSON)
  responsesJson Json // Object with field_id: value pairs

  status        String    @default("Draft") // 'Draft', 'Submitted', 'Reviewed'
  submittedDate DateTime?
  reviewedDate  DateTime?
  reviewedBy    String?
  reviewerNotes String?

  // E-Signature fields
  signatureData      String? // Base64 encoded signature image (canvas drawing)
  signedByName       String? // Full name entered by client
  signedDate         DateTime?
  signatureIpAddress String? // IP address at time of signature
  consentAgreed      Boolean   @default(false) // Client agreed to e-signature consent

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignment FormAssignment?

  @@map("intake_form_submissions")
}

// Client Portal - Assessment Assignments
model AssessmentAssignment {
  id String @id @default(uuid())

  clientId String

  assessmentName String
  assessmentType String // 'PHQ9', 'GAD7', 'PCL5', 'BAI', 'BDI', 'Custom'
  description    String?

  assignedBy String
  assignedAt DateTime  @default(now())
  dueDate    DateTime?

  status      String    @default("PENDING") // 'PENDING', 'IN_PROGRESS', 'COMPLETED'
  completedAt DateTime?

  // Results
  score          Int?
  interpretation String?
  responses      Json? // Question responses

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, status])
  @@map("assessment_assignments")
}

// Client Portal - Secure Messaging
model PortalMessage {
  id String @id @default(uuid())

  clientId String

  subject String
  message String

  sentByClient Boolean @default(true)
  sentBy       String // User ID or Client ID

  recipientId String? // Clinician/staff user ID

  isRead   Boolean   @default(false)
  readDate DateTime?

  // Thread tracking
  threadId        String? // Group related messages
  parentMessageId String?

  // Attachments
  attachmentsJson Json? // Array of attachment objects with S3 URLs

  priority String @default("Normal") // 'Low', 'Normal', 'High', 'Urgent'

  // Flags
  requiresResponse Boolean   @default(false)
  respondedDate    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, createdAt])
  @@index([threadId])
  @@map("portal_messages")
}

// Client Portal - Prescription Refill Requests
model PrescriptionRefillRequest {
  id       String @id @default(uuid())
  clientId String

  medicationName String
  currentDosage  String
  prescriberId   String // Clinician user ID
  pharmacyName   String?
  pharmacyPhone  String?

  requestReason String?
  urgency       String  @default("Routine") // 'Routine', 'Urgent'

  status          String   @default("Pending") // 'Pending', 'Approved', 'Denied', 'Completed'
  statusDate      DateTime @default(now())
  statusUpdatedBy String?

  reviewedBy   String?
  reviewedDate DateTime?
  reviewNotes  String?

  denialReason String?

  approvedDate      DateTime?
  approvedBy        String?
  approvedDosage    String?
  approvedQuantity  Int?
  refillsAuthorized Int?

  prescriptionSentDate DateTime?
  prescriptionNumber   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, status])
  @@map("prescription_refill_requests")
}

// ============================================================================
// PHASE 8: BILLING & FINANCIAL
// ============================================================================

model ChargeEntry {
  id            String  @id @default(uuid())
  clientId      String
  client        Client  @relation(fields: [clientId], references: [id])
  appointmentId String?

  serviceDate           DateTime
  providerId            String
  supervisingProviderId String?

  cptCode        String
  cptDescription String
  modifiers      String[]
  units          Int      @default(1)

  diagnosisCodesJson Json // Array of diagnosis objects

  placeOfService String
  locationId     String?

  chargeAmount         Decimal  @db.Decimal(10, 2)
  allowedAmount        Decimal? @db.Decimal(10, 2)
  adjustmentAmount     Decimal? @db.Decimal(10, 2)
  paymentAmount        Decimal? @db.Decimal(10, 2)
  clientResponsibility Decimal? @db.Decimal(10, 2)

  primaryInsuranceId   String?
  secondaryInsuranceId String?

  chargeStatus String    @default("Unbilled")
  claimId      String?
  claimStatus  String?
  billedDate   DateTime?

  denialCode   String?
  denialReason String?
  appealFiled  Boolean   @default(false)
  appealDate   DateTime?

  writeOffAmount Decimal?  @db.Decimal(10, 2)
  writeOffReason String?
  writeOffDate   DateTime?

  createdAt DateTime @default(now())
  createdBy String

  @@map("charge_entries")
}

model PaymentRecord {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  paymentDate   DateTime
  paymentAmount Decimal  @db.Decimal(10, 2)

  paymentSource String // Insurance, Client, Guarantor
  paymentMethod String // Check, Card, Cash, ACH

  checkNumber   String?
  cardLast4     String?
  transactionId String?

  appliedPaymentsJson Json // Array of applied payment objects

  eobDate       DateTime?
  eobAttachment String? // S3 URL
  claimNumber   String?

  adjustmentsJson Json? // Array of adjustment objects

  overpaymentAmount Decimal?  @db.Decimal(10, 2)
  refundIssued      Boolean   @default(false)
  refundDate        DateTime?
  refundAmount      Decimal?  @db.Decimal(10, 2)

  unappliedAmount Decimal @default(0) @db.Decimal(10, 2)

  paymentStatus String @default("Posted")

  postedBy   String
  postedDate DateTime @default(now())
  notes      String?

  createdAt DateTime @default(now())

  @@map("payment_records")
}

model ClientStatement {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  statementDate   DateTime
  periodStartDate DateTime
  periodEndDate   DateTime

  previousBalance Decimal @db.Decimal(10, 2)
  currentCharges  Decimal @db.Decimal(10, 2)
  payments        Decimal @db.Decimal(10, 2)
  adjustments     Decimal @db.Decimal(10, 2)
  currentBalance  Decimal @db.Decimal(10, 2)

  aging0to30   Decimal @db.Decimal(10, 2)
  aging31to60  Decimal @db.Decimal(10, 2)
  aging61to90  Decimal @db.Decimal(10, 2)
  aging91to120 Decimal @db.Decimal(10, 2)
  aging120Plus Decimal @db.Decimal(10, 2)

  statementMessage String?
  dueDate          DateTime?

  statementStatus String    @default("Generated")
  sentDate        DateTime?
  sentMethod      String? // Mail, Email, Portal

  viewedInPortal Boolean   @default(false)
  viewedDate     DateTime?

  inCollections    Boolean   @default(false)
  collectionDate   DateTime?
  collectionAgency String?

  createdAt DateTime @default(now())

  @@map("client_statements")
}

// ============================================================================
// PHASE 10: DOCUMENT MANAGEMENT
// ============================================================================

model ClientDocument {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  documentName        String
  documentType        String
  documentCategory    String?
  documentDescription String?

  fileUrl  String
  fileName String
  fileSize Int
  fileType String

  uploadedBy     String
  uploadedDate   DateTime @default(now())
  uploadedMethod String

  documentSource   String
  externalProvider String?
  documentDate     DateTime

  requiresSignature Boolean @default(false)
  signaturesJson    Json? // Array of signature objects

  sharedWithClient Boolean   @default(false)
  sharedViaPortal  Boolean   @default(false)
  sharedDate       DateTime?
  clientViewedDate DateTime?

  isEmbeddedForm    Boolean @default(false)
  formResponsesJson Json?

  versionNumber     Int     @default(1)
  previousVersionId String?
  latestVersion     Boolean @default(true)

  ocrProcessed  Boolean @default(false)
  extractedText String?

  tags   String[]
  status String   @default("Active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  relationshipConsents ClientRelationship[]

  @@map("client_documents")
}

// ============================================================================
// PHASE 9: ENHANCED CLIENT PORTAL - MENTAL HEALTH COMPANION
// ============================================================================

// Category 1: Core Transactional Features

model InsuranceCard {
  id              String   @id @default(uuid())
  clientId        String
  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  insuranceType   String // 'PRIMARY', 'SECONDARY'
  frontImageS3Key String
  backImageS3Key  String
  insuranceName   String?
  policyNumber    String?
  groupNumber     String?
  uploadedAt      DateTime @default(now())
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  @@index([clientId, isActive])
  @@map("insurance_cards")
}

model PaymentMethod {
  id                    String   @id @default(uuid())
  clientId              String
  client                Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  stripePaymentMethodId String   @unique
  cardBrand             String // 'visa', 'mastercard', etc.
  cardLast4             String
  cardExpMonth          Int
  cardExpYear           Int
  isDefault             Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([clientId, isDefault])
  @@map("payment_methods")
}

model FormAssignment {
  id               String                @id @default(uuid())
  formId           String
  clientId         String
  client           Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  assignedBy       String // User ID of therapist/admin
  assignedAt       DateTime              @default(now())
  dueDate          DateTime?
  isRequired       Boolean               @default(false)
  assignmentNotes  String? // Internal notes for therapist
  clientMessage    String? // Message to send to client
  status           String                @default("PENDING") // 'PENDING', 'IN_PROGRESS', 'COMPLETED'
  completedAt      DateTime?
  submissionId     String?               @unique
  lastReminderSent DateTime?
  form             IntakeForm            @relation(fields: [formId], references: [id])
  submission       IntakeFormSubmission? @relation(fields: [submissionId], references: [id])

  @@index([clientId, status])
  @@map("form_assignments")
}

model DocumentSignature {
  id               String   @id @default(uuid())
  documentId       String
  signedBy         String // Client ID or User ID
  signatureImageS3 String // S3 key for signature image
  signedAt         DateTime @default(now())
  ipAddress        String
  userAgent        String
  deviceInfo       Json?
  signatureType    String // 'ELECTRONIC', 'DIGITAL'
  isValid          Boolean  @default(true)
  createdAt        DateTime @default(now())

  @@index([documentId, signedBy])
  @@map("document_signatures")
}

model SharedDocument {
  id            String    @id @default(uuid())
  clientId      String
  documentType  String // 'TREATMENT_PLAN', 'SESSION_SUMMARY', 'CONSENT_FORM', etc.
  documentName  String
  documentS3Key String
  sharedBy      String // User ID
  sharedAt      DateTime  @default(now())
  expiresAt     DateTime?
  viewCount     Int       @default(0)
  lastViewedAt  DateTime?
  isActive      Boolean   @default(true)

  @@index([clientId, isActive])
  @@map("shared_documents")
}

model SessionReview {
  id                    String      @id @default(uuid())
  appointmentId         String      @unique
  appointment           Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  clientId              String
  client                Client      @relation("SessionReviewClient", fields: [clientId], references: [id], onDelete: Cascade)
  clinicianId           String
  clinician             User        @relation("SessionReviewClinician", fields: [clinicianId], references: [id])
  rating                Int // 1-5 stars
  feedback              String?
  categories            Json? // { "effectiveness": 5, "alliance": 4, "environment": 5 }
  isSharedWithClinician Boolean     @default(false)
  isAnonymous           Boolean     @default(false)
  clinicianViewed       Boolean     @default(false)
  clinicianViewedAt     DateTime?
  clinicianResponse     String?
  clinicianRespondedAt  DateTime?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  @@index([clinicianId, isSharedWithClinician])
  @@index([clientId, createdAt])
  @@map("session_reviews")
}

model TherapistChangeRequest {
  id                  String    @id @default(uuid())
  clientId            String
  client              Client    @relation("ChangeRequestClient", fields: [clientId], references: [id], onDelete: Cascade)
  currentClinicianId  String
  currentClinician    User      @relation("ChangeRequestCurrentClinician", fields: [currentClinicianId], references: [id])
  requestReason       String // 'SCHEDULE_CONFLICT', 'THERAPEUTIC_FIT', 'SPECIALTY_NEEDS', 'PERSONAL_PREFERENCE', 'OTHER'
  reasonDetails       String
  isSensitive         Boolean   @default(false)
  status              String    @default("PENDING") // 'PENDING', 'UNDER_REVIEW', 'APPROVED', 'COMPLETED', 'DENIED'
  reviewedBy          String? // Admin user ID
  reviewedAt          DateTime?
  reviewNotes         String?
  newClinicianId      String?
  newClinician        User?     @relation("ChangeRequestNewClinician", fields: [newClinicianId], references: [id])
  assignedAt          DateTime?
  transferCompletedAt DateTime?
  denialReason        String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([clientId, status])
  @@index([status, reviewedAt])
  @@map("therapist_change_requests")
}

// Client Referral System
model ClientReferral {
  id                  String  @id @default(uuid())
  referredByClientId  String // Existing client making the referral
  referredPersonName  String
  referredPersonEmail String?
  referredPersonPhone String
  relationship        String? // 'Friend', 'Family', 'Colleague', 'Other'
  referralReason      String? // Why they think person needs services
  additionalNotes     String?

  status        String    @default("PENDING") // 'PENDING', 'CONTACTED', 'SCHEDULED_INTAKE', 'BECAME_CLIENT', 'DECLINED', 'NO_RESPONSE'
  contactedDate DateTime?
  contactedBy   String? // Staff user ID who made contact
  contactNotes  String?

  intakeScheduledDate  DateTime?
  appointmentScheduled Boolean   @default(false)

  convertedToClientId String? // If they become a client, link to Client.id
  convertedDate       DateTime?

  incentiveEarned      Boolean   @default(false)
  incentiveAmount      Decimal?  @db.Decimal(10, 2)
  incentiveAppliedDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([referredByClientId, status])
  @@index([status, createdAt])
  @@map("client_referrals")
}

// Category 2: Daily Engagement Features

model MoodEntry {
  id                  String   @id @default(uuid())
  clientId            String
  client              Client   @relation("ClientMoodEntry", fields: [clientId], references: [id], onDelete: Cascade)
  entryDate           DateTime
  timeOfDay           String // 'MORNING', 'AFTERNOON', 'EVENING'
  moodScore           Int // 1-10
  symptoms            String[] // ['ANXIETY', 'DEPRESSION', 'INSOMNIA', 'FATIGUE', etc.]
  customMetrics       Json? // { "irritability": 7, "motivation": 3 }
  notes               String?
  sharedWithClinician Boolean  @default(true)
  createdAt           DateTime @default(now())

  @@index([clientId, entryDate])
  @@map("mood_entries")
}

model SymptomDefinition {
  id          String   @id @default(uuid())
  symptomName String
  symptomType String // 'STANDARD', 'CUSTOM'
  createdBy   String? // User ID if custom
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@map("symptom_definitions")
}

model ClientSymptomTracker {
  id         String   @id @default(uuid())
  clientId   String
  client     Client   @relation("ClientSymptomTracker", fields: [clientId], references: [id], onDelete: Cascade)
  symptomId  String
  isEnabled  Boolean  @default(true)
  assignedBy String // User ID of therapist
  assignedAt DateTime @default(now())

  @@unique([clientId, symptomId])
  @@map("client_symptom_trackers")
}

model DailyPrompt {
  id         String           @id @default(uuid())
  clientId   String
  client     Client           @relation("ClientDailyPrompt", fields: [clientId], references: [id], onDelete: Cascade)
  createdBy  String // User ID of therapist
  creator    User             @relation("DailyPromptCreator", fields: [createdBy], references: [id])
  promptType String // 'GRATITUDE', 'COGNITIVE_REFRAME', 'BEHAVIORAL_ACTIVATION', etc.
  promptText String
  schedule   Json // { "frequency": "DAILY", "time": "09:00", "daysOfWeek": [1,2,3,4,5] }
  startDate  DateTime
  endDate    DateTime?
  isActive   Boolean          @default(true)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  responses  PromptResponse[]

  @@index([clientId, isActive, startDate])
  @@map("daily_prompts")
}

model PromptResponse {
  id           String      @id @default(uuid())
  promptId     String
  prompt       DailyPrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
  clientId     String
  client       Client      @relation("ClientPromptResponse", fields: [clientId], references: [id], onDelete: Cascade)
  responseText String
  imageS3Key   String?
  respondedAt  DateTime    @default(now())

  @@index([clientId, respondedAt])
  @@map("prompt_responses")
}

model EngagementStreak {
  id                 String    @id @default(uuid())
  clientId           String    @unique
  client             Client    @relation("ClientStreak", fields: [clientId], references: [id], onDelete: Cascade)
  currentStreak      Int       @default(0)
  longestStreak      Int       @default(0)
  lastCheckInDate    DateTime?
  totalCheckIns      Int       @default(0)
  milestonesAchieved Json      @default("[]") // [7, 14, 30, 60, 90]
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@map("engagement_streaks")
}

model Milestone {
  id             String    @id @default(uuid())
  clientId       String
  client         Client    @relation("ClientMilestone", fields: [clientId], references: [id], onDelete: Cascade)
  milestoneType  String // 'STREAK', 'TOTAL_CHECKINS', 'HOMEWORK_COMPLETION', etc.
  milestoneValue Int
  achievedAt     DateTime  @default(now())
  badgeName      String
  isViewed       Boolean   @default(false)
  viewedAt       DateTime?

  @@index([clientId, achievedAt])
  @@map("milestones")
}

model PreSessionPrep {
  id                String      @id @default(uuid())
  appointmentId     String      @unique
  appointment       Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  clientId          String
  client            Client      @relation("ClientPreSessionPrep", fields: [clientId], references: [id], onDelete: Cascade)
  topicsToDiscuss   String?
  recentFeelings    String?
  homeworkStatus    String? // 'COMPLETED', 'PARTIALLY_COMPLETED', 'NOT_COMPLETED'
  urgentConcerns    String?
  isUrgent          Boolean     @default(false)
  submittedAt       DateTime    @default(now())
  viewedByClinician Boolean     @default(false)
  viewedAt          DateTime?

  @@index([clientId, submittedAt])
  @@map("pre_session_preps")
}

// Category 3: Between-Session Support

model Resource {
  id           String               @id @default(uuid())
  resourceType String // 'ARTICLE', 'VIDEO', 'PDF', 'WORKSHEET', 'AUDIO'
  title        String
  description  String?
  contentUrl   String?
  contentS3Key String?
  category     String // 'COPING_SKILLS', 'PSYCHOEDUCATION', 'EXERCISES', etc.
  tags         String[]
  createdBy    String // User ID
  creator      User                 @relation("ResourceCreator", fields: [createdBy], references: [id])
  isPublic     Boolean              @default(false)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  assignments  ResourceAssignment[]

  @@map("resources")
}

model ResourceAssignment {
  id             String    @id @default(uuid())
  resourceId     String
  resource       Resource  @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  clientId       String
  client         Client    @relation("ClientResourceAssignment", fields: [clientId], references: [id], onDelete: Cascade)
  assignedBy     String // User ID
  assigner       User      @relation("ResourceAssigner", fields: [assignedBy], references: [id])
  priority       String    @default("OPTIONAL") // 'REQUIRED', 'RECOMMENDED', 'OPTIONAL'
  therapistNotes String?
  assignedAt     DateTime  @default(now())
  viewedAt       DateTime?
  completedAt    DateTime?
  clientRating   Int? // 1-5
  clientFeedback String?

  @@index([clientId, assignedAt])
  @@map("resource_assignments")
}

model CrisisToolkit {
  id                 String               @id @default(uuid())
  clientId           String               @unique
  client             Client               @relation("ClientCrisisToolkit", fields: [clientId], references: [id], onDelete: Cascade)
  enabledTools       String[] // ['GROUNDING', 'BREATHING', 'COPING_STRATEGIES', etc.]
  safetyPlanS3Key    String?
  customInstructions String?
  emergencyContacts  Json // [{ "name": "Dr. Smith", "phone": "555-1234", "relationship": "Therapist" }]
  lastUpdatedBy      String // User ID
  manager            User                 @relation("CrisisToolkitManager", fields: [lastUpdatedBy], references: [id])
  lastUpdatedAt      DateTime             @default(now())
  createdAt          DateTime             @default(now())
  usageLogs          CrisisToolkitUsage[]

  @@map("crisis_toolkits")
}

model CrisisToolkitUsage {
  id              String        @id @default(uuid())
  clientId        String
  client          Client        @relation("ClientCrisisUsage", fields: [clientId], references: [id], onDelete: Cascade)
  toolkitId       String
  toolkit         CrisisToolkit @relation(fields: [toolkitId], references: [id], onDelete: Cascade)
  accessedAt      DateTime      @default(now())
  toolUsed        String? // 'GROUNDING', 'BREATHING', 'SAFETY_PLAN', etc.
  durationSeconds Int?

  @@index([clientId, accessedAt])
  @@map("crisis_toolkit_usage")
}

model AudioMessage {
  id              String         @id @default(uuid())
  clientId        String
  client          Client         @relation("ClientAudioMessage", fields: [clientId], references: [id], onDelete: Cascade)
  createdBy       String // User ID of therapist
  creator         User           @relation("AudioMessageCreator", fields: [createdBy], references: [id])
  title           String
  description     String?
  category        String // 'GROUNDING', 'AFFIRMATION', 'COPING_SKILL', 'PERSONALIZED'
  audioS3Key      String
  durationSeconds Int
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  playLogs        AudioPlayLog[]

  @@map("audio_messages")
}

model AudioPlayLog {
  id             String       @id @default(uuid())
  audioId        String
  audio          AudioMessage @relation(fields: [audioId], references: [id], onDelete: Cascade)
  clientId       String
  client         Client       @relation("ClientAudioPlayLog", fields: [clientId], references: [id], onDelete: Cascade)
  playedAt       DateTime     @default(now())
  durationPlayed Int // Seconds
  completedFully Boolean      @default(false)
  helpfulRating  Int? // 1-5

  @@index([clientId, playedAt])
  @@map("audio_play_logs")
}

model HomeworkAssignment {
  id                    String    @id @default(uuid())
  clientId              String
  client                Client    @relation("ClientHomework", fields: [clientId], references: [id], onDelete: Cascade)
  assignedBy            String // User ID
  assigner              User      @relation("HomeworkAssigner", fields: [assignedBy], references: [id])
  title                 String
  description           String
  homeworkType          String // 'BEHAVIORAL_EXPERIMENT', 'THOUGHT_RECORD', 'READING', 'SKILL_PRACTICE'
  instructions          String?
  attachmentS3Keys      String[] // Worksheet templates
  dueDate               DateTime
  status                String    @default("ASSIGNED") // 'ASSIGNED', 'IN_PROGRESS', 'COMPLETED', 'REVIEWED'
  assignedAt            DateTime  @default(now())
  startedAt             DateTime?
  completedAt           DateTime?
  reviewedAt            DateTime?
  completionNotes       String?
  completionAttachments String[] // Client uploads
  therapistFeedback     String?

  @@index([clientId, status, dueDate])
  @@map("homework_assignments")
}

// Category 4: Progress & Motivation

model TherapeuticGoal {
  id              String               @id @default(uuid())
  clientId        String
  client          Client               @relation("ClientGoal", fields: [clientId], references: [id], onDelete: Cascade)
  createdBy       String // User ID (can be client or therapist)
  creator         User                 @relation("GoalCreator", fields: [createdBy], references: [id])
  goalTitle       String
  goalDescription String?
  goalCategory    String // 'SYMPTOM_REDUCTION', 'SKILL_BUILDING', 'LIFE_GOAL', 'BEHAVIORAL_GOAL'
  targetDate      DateTime?
  status          String               @default("ACTIVE") // 'ACTIVE', 'ACHIEVED', 'MODIFIED', 'DISCONTINUED'
  progressPercent Int                  @default(0)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  achievedAt      DateTime?
  subGoals        SubGoal[]
  progressUpdates GoalProgressUpdate[]

  @@index([clientId, status])
  @@map("therapeutic_goals")
}

model SubGoal {
  id           String          @id @default(uuid())
  parentGoalId String
  parentGoal   TherapeuticGoal @relation(fields: [parentGoalId], references: [id], onDelete: Cascade)
  title        String
  isCompleted  Boolean         @default(false)
  completedAt  DateTime?
  createdAt    DateTime        @default(now())

  @@map("sub_goals")
}

model GoalProgressUpdate {
  id              String          @id @default(uuid())
  goalId          String
  goal            TherapeuticGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)
  updatedBy       String // User ID (client or therapist)
  updater         User            @relation("GoalUpdater", fields: [updatedBy], references: [id])
  progressPercent Int
  updateNotes     String?
  updatedAt       DateTime        @default(now())

  @@index([goalId, updatedAt])
  @@map("goal_progress_updates")
}

model WinEntry {
  id         String       @id @default(uuid())
  clientId   String
  client     Client       @relation("ClientWinEntry", fields: [clientId], references: [id], onDelete: Cascade)
  winText    String
  category   String? // 'PERSONAL', 'PROFESSIONAL', 'THERAPEUTIC', 'RELATIONSHIPS'
  tags       String[]
  imageS3Key String?
  createdAt  DateTime     @default(now())
  comments   WinComment[]

  @@index([clientId, createdAt])
  @@map("win_entries")
}

model WinComment {
  id          String   @id @default(uuid())
  winId       String
  win         WinEntry @relation(fields: [winId], references: [id], onDelete: Cascade)
  commentedBy String // User ID
  commenter   User     @relation("WinCommenter", fields: [commentedBy], references: [id])
  commentText String
  commentedAt DateTime @default(now())

  @@index([winId, commentedAt])
  @@map("win_comments")
}

model CopingSkillLog {
  id            String   @id @default(uuid())
  clientId      String
  client        Client   @relation("ClientCopingSkillLog", fields: [clientId], references: [id], onDelete: Cascade)
  skillName     String
  skillCategory String // 'BREATHING', 'GROUNDING', 'DISTRACTION', etc.
  feelingBefore Int // 1-10
  feelingAfter  Int // 1-10
  effectiveness Int // Calculated: difference
  reflection    String?
  usedAt        DateTime @default(now())

  @@index([clientId, usedAt])
  @@index([clientId, skillName])
  @@map("coping_skill_logs")
}

// Category 5: Smart Notifications

model ScheduledCheckIn {
  id             String    @id @default(uuid())
  clientId       String
  client         Client    @relation("ClientScheduledCheckIn", fields: [clientId], references: [id], onDelete: Cascade)
  createdBy      String // User ID
  creator        User      @relation("CheckInCreator", fields: [createdBy], references: [id])
  questionText   String
  scheduledFor   DateTime
  isRecurring    Boolean   @default(false)
  recurrenceRule Json?
  status         String    @default("SCHEDULED") // 'SCHEDULED', 'SENT', 'RESPONDED', 'SKIPPED'
  sentAt         DateTime?
  responseText   String?
  respondedAt    DateTime?
  createdAt      DateTime  @default(now())

  @@index([clientId, scheduledFor])
  @@map("scheduled_check_ins")
}

model ReminderNudge {
  id          String          @id @default(uuid())
  clientId    String
  client      Client          @relation("ClientReminderNudge", fields: [clientId], references: [id], onDelete: Cascade)
  nudgeType   String // 'MEDICATION', 'BREATHING', 'CHECK_IN', etc.
  nudgeText   String
  triggerRule Json // { "pattern": "HIGH_ANXIETY", "days": ["MONDAY"], "time": "09:00" }
  isActive    Boolean         @default(true)
  createdBy   String? // User ID or 'SYSTEM'
  createdAt   DateTime        @default(now())
  deliveries  NudgeDelivery[]

  @@map("reminder_nudges")
}

model NudgeDelivery {
  id          String        @id @default(uuid())
  nudgeId     String
  nudge       ReminderNudge @relation(fields: [nudgeId], references: [id], onDelete: Cascade)
  sentAt      DateTime      @default(now())
  wasActioned Boolean       @default(false)
  actionedAt  DateTime?

  @@index([nudgeId, sentAt])
  @@map("nudge_deliveries")
}

model MicroContent {
  id          String                 @id @default(uuid())
  contentText String
  contentType String // 'TIP', 'QUOTE', 'REMINDER', 'INSIGHT'
  categories  String[] // ['ANXIETY', 'DEPRESSION', 'DBT', 'CBT']
  createdBy   String? // User ID or 'SYSTEM'
  isApproved  Boolean                @default(false)
  approvedBy  String?
  createdAt   DateTime               @default(now())
  deliveries  MicroContentDelivery[]

  @@map("micro_content")
}

model MicroContentDelivery {
  id            String       @id @default(uuid())
  contentId     String
  content       MicroContent @relation(fields: [contentId], references: [id], onDelete: Cascade)
  clientId      String
  client        Client       @relation("ClientMicroContent", fields: [clientId], references: [id], onDelete: Cascade)
  deliveredAt   DateTime     @default(now())
  wasViewed     Boolean      @default(false)
  viewedAt      DateTime?
  helpfulRating Int? // 1-5

  @@index([clientId, deliveredAt])
  @@map("micro_content_deliveries")
}

// Category 6: Journaling with AI

model JournalEntry {
  id                    String            @id @default(uuid())
  clientId              String
  client                Client            @relation("ClientJournalEntry", fields: [clientId], references: [id], onDelete: Cascade)
  entryText             String
  entryDate             DateTime          @default(now())
  isSharedWithClinician Boolean           @default(false)
  aiPromptsEnabled      Boolean           @default(true)
  voiceToText           Boolean           @default(false)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  aiPrompts             AIJournalPrompt[]
  clinicianComments     JournalComment[]

  @@index([clientId, entryDate])
  @@map("journal_entries")
}

model AIJournalPrompt {
  id          String       @id @default(uuid())
  entryId     String
  entry       JournalEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  promptText  String
  generatedAt DateTime     @default(now())
  wasAnswered Boolean      @default(false)
  answerText  String?
  answeredAt  DateTime?

  @@map("ai_journal_prompts")
}

model JournalComment {
  id          String       @id @default(uuid())
  entryId     String
  entry       JournalEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  commentedBy String // User ID
  commenter   User         @relation("JournalCommenter", fields: [commentedBy], references: [id])
  commentText String
  commentedAt DateTime     @default(now())

  @@map("journal_comments")
}

// Category 7: Two-Way Communication

model VoiceMemo {
  id              String   @id @default(uuid())
  messageId       String // Links to PortalMessage
  sentBy          String // User ID or Client ID
  audioS3Key      String
  durationSeconds Int
  transcription   String? // Optional AI transcription
  createdAt       DateTime @default(now())

  @@index([messageId])
  @@map("voice_memos")
}

model SessionSummary {
  id                 String      @id @default(uuid())
  appointmentId      String      @unique
  appointment        Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  clinicianId        String
  clinician          User        @relation("SessionSummaryCreator", fields: [clinicianId], references: [id])
  clientId           String
  client             Client      @relation("ClientSessionSummary", fields: [clientId], references: [id], onDelete: Cascade)
  summaryText        String
  keyPoints          String[]
  homeworkAssigned   String?
  goalsDiscussed     String[]
  isSharedWithClient Boolean     @default(false)
  sharedAt           DateTime?
  pdfS3Key           String?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  @@index([clientId, sharedAt])
  @@map("session_summaries")
}

// Module 7: Crisis Detection and Safety Monitoring
model CrisisDetectionLog {
  id             String  @id @default(uuid())
  messageId      String  @unique // References the message that triggered detection
  userId         String // Who sent the message
  conversationId String? // Which conversation/session

  // Detection details
  detectedAt     DateTime @default(now())
  keywords       String[] // Which keywords triggered the alert
  severity       String // 'CRITICAL', 'HIGH', 'MEDIUM'
  messageSnippet String // Excerpt of the message for context

  // Notifications
  notificationsSent Boolean  @default(false)
  notifiedUsers     String[] // Array of user IDs who were notified

  // Review
  reviewedBy    String?
  reviewedAt    DateTime?
  reviewNotes   String?
  falsePositive Boolean   @default(false)
  actionTaken   String?

  @@index([userId])
  @@index([conversationId])
  @@index([severity])
  @@index([detectedAt])
  @@index([reviewedBy])
  @@map("crisis_detection_logs")
}

// Module 7: Client Self-Tracking - Symptom Logs
model SymptomLog {
  id       String   @id @default(uuid())
  clientId String
  client   Client   @relation("ClientSymptomLogs", fields: [clientId], references: [id], onDelete: Cascade)
  loggedAt DateTime @default(now())

  // Symptom tracking
  symptoms String[] // Array of symptom names
  severity Int // 1-10 scale
  triggers String[]
  notes    String?

  // Context
  mood        String? // 'VERY_POOR', 'POOR', 'NEUTRAL', 'GOOD', 'VERY_GOOD'
  duration    String? // How long symptoms lasted
  medications String[] // Medications taken

  createdAt DateTime @default(now())

  @@index([clientId, loggedAt])
  @@map("symptom_logs")
}

// Module 7: Client Self-Tracking - Sleep Logs
model SleepLog {
  id       String   @id @default(uuid())
  clientId String
  client   Client   @relation("ClientSleepLogs", fields: [clientId], references: [id], onDelete: Cascade)
  logDate  DateTime // The date of the sleep

  // Sleep tracking
  bedtime      DateTime
  wakeTime     DateTime
  hoursSlept   Float // Calculated or manual entry
  quality      Int // 1-5 scale
  disturbances String[] // ['NIGHTMARES', 'INSOMNIA', 'WOKE_FREQUENTLY']
  notes        String?

  createdAt DateTime @default(now())

  @@index([clientId, logDate])
  @@map("sleep_logs")
}

// Module 7: Client Self-Tracking - Exercise Logs
model ExerciseLog {
  id       String   @id @default(uuid())
  clientId String
  client   Client   @relation("ClientExerciseLogs", fields: [clientId], references: [id], onDelete: Cascade)
  loggedAt DateTime @default(now())

  // Exercise tracking
  activityType String // 'WALKING', 'RUNNING', 'YOGA', 'GYM', 'SPORTS', 'OTHER'
  duration     Int // Minutes
  intensity    String // 'LOW', 'MODERATE', 'HIGH'
  notes        String?
  mood         String? // Mood after exercise

  createdAt DateTime @default(now())

  @@index([clientId, loggedAt])
  @@map("exercise_logs")
}

// Module 7: Guardian/Minor Access Control
model GuardianRelationship {
  id         String @id @default(uuid())
  guardianId String
  guardian   User   @relation("GuardianRelationships", fields: [guardianId], references: [id])
  minorId    String
  minor      Client @relation("MinorRelationships", fields: [minorId], references: [id], onDelete: Cascade)

  // Relationship details
  relationshipType String // 'PARENT', 'LEGAL_GUARDIAN', 'HEALTHCARE_PROXY'
  accessLevel      String // 'FULL', 'LIMITED', 'VIEW_ONLY'

  // Permissions
  canScheduleAppointments     Boolean @default(true)
  canViewRecords              Boolean @default(true)
  canCommunicateWithClinician Boolean @default(true)

  // Verification
  verificationStatus    String // 'PENDING', 'VERIFIED', 'REJECTED'
  verificationDocuments String[] // URLs to uploaded verification
  verifiedBy            String?
  verifiedAt            DateTime?

  // Validity period
  startDate DateTime  @default(now())
  endDate   DateTime? // When guardian access expires
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([guardianId])
  @@index([minorId])
  @@index([verificationStatus])
  @@map("guardian_relationships")
}

// Module 7: Medication Adherence Tracking (BACKEND ONLY - NO UI)
model MedicationAdherence {
  id             String    @id @default(uuid())
  clientId       String
  client         Client    @relation("ClientMedicationAdherence", fields: [clientId], references: [id], onDelete: Cascade)
  medicationName String
  dosage         String
  frequency      String // 'DAILY', 'TWICE_DAILY', 'WEEKLY', etc.
  prescribedBy   String? // Clinician ID
  startDate      DateTime
  endDate        DateTime?

  // Tracking
  taken        Boolean
  takenAt      DateTime?
  missedReason String?
  notes        String?

  createdAt DateTime @default(now())

  @@index([clientId, startDate])
  @@map("medication_adherence")
}

// ============================================================================
// SYSTEM TABLES
// ============================================================================

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  clientId   String?
  action     String
  entityType String
  entityId   String
  changes    Json?
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())

  @@map("audit_logs")
}

model SystemConfig {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   String

  @@map("system_config")
}

// ============================================================================
// PHASE 6: PRODUCTIVITY & ACCOUNTABILITY MODULE (ADDED OCT 2025)
// ============================================================================

model ProductivityMetric {
  id           String   @id @default(uuid())
  clinicianId  String
  metricType   String // 'KVR', 'NO_SHOW_RATE', 'DOCUMENTATION_RATE', etc.
  metricValue  Decimal  @db.Decimal(10, 2)
  periodStart  DateTime
  periodEnd    DateTime
  calculatedAt DateTime @default(now())
  metadata     Json? // Additional context (e.g., numerator, denominator)
  createdAt    DateTime @default(now())

  clinician User @relation("ProductivityMetrics", fields: [clinicianId], references: [id])

  @@index([clinicianId, metricType, periodStart])
  @@map("productivity_metrics")
}

model ComplianceAlert {
  id             String    @id @default(uuid())
  alertType      String // 'UNSIGNED_NOTE', 'TREATMENT_PLAN_OVERDUE', 'SUPERVISION_HOURS', etc.
  severity       String // 'INFO', 'WARNING', 'CRITICAL'
  targetUserId   String // Clinician or staff member
  supervisorId   String? // Escalated to supervisor
  adminId        String? // Escalated to admin
  message        String
  actionRequired String
  status         String    @default("OPEN") // 'OPEN', 'ACKNOWLEDGED', 'RESOLVED'
  acknowledgedAt DateTime?
  resolvedAt     DateTime?
  metadata       Json? // Additional context
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  targetUser User  @relation("AlertTarget", fields: [targetUserId], references: [id])
  supervisor User? @relation("AlertSupervisor", fields: [supervisorId], references: [id])
  admin      User? @relation("AlertAdmin", fields: [adminId], references: [id])

  @@index([targetUserId, status])
  @@index([supervisorId, status])
  @@map("compliance_alerts")
}

model GeorgiaComplianceRule {
  id         String   @id @default(uuid())
  ruleType   String // 'NOTE_SIGNATURE_DEADLINE', 'TREATMENT_PLAN_REVIEW', etc.
  ruleConfig Json // Configuration (e.g., { "deadlineDays": 7 })
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("georgia_compliance_rules")
}

model PerformanceGoal {
  id          String   @id @default(uuid())
  userId      String
  metricType  String // 'KVR', 'NO_SHOW_RATE', etc.
  targetValue Decimal  @db.Decimal(10, 2)
  startDate   DateTime
  endDate     DateTime
  status      String   @default("ACTIVE") // 'ACTIVE', 'ACHIEVED', 'MISSED'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation("PerformanceGoals", fields: [userId], references: [id])

  @@index([userId, status])
  @@map("performance_goals")
}

// ============================================================================
// PHASE 1.4: LEGAL ELECTRONIC SIGNATURES & ATTESTATIONS
// ============================================================================

model SignatureAttestation {
  id              String   @id @default(uuid())
  role            String // CLINICIAN, SUPERVISOR, ADMIN
  noteType        String // INTAKE, PROGRESS, TREATMENT_PLAN, etc.
  jurisdiction    String // State code (GA, FL, etc.)
  payerId         String? // Specific payer if needed
  attestationText String   @db.Text // Legal language
  isActive        Boolean  @default(true)
  effectiveDate   DateTime
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  signatureEvents SignatureEvent[] @relation("AttestationSignatureEvents")

  @@index([role, noteType, jurisdiction, isActive])
  @@map("signature_attestations")
}

model SignatureEvent {
  id            String               @id @default(uuid())
  noteId        String
  note          ClinicalNote         @relation("NoteSignatureEvents", fields: [noteId], references: [id])
  userId        String
  user          User                 @relation("UserSignatureEvents", fields: [userId], references: [id])
  signatureType String // AUTHOR, COSIGN, AMENDMENT
  attestationId String
  attestation   SignatureAttestation @relation("AttestationSignatureEvents", fields: [attestationId], references: [id])
  signedAt      DateTime             @default(now())
  ipAddress     String
  userAgent     String
  authMethod    String // PASSWORD, PIN, BIOMETRIC, MFA
  signatureData String? // Base64 image if drawn
  isValid       Boolean              @default(true)
  revokedAt     DateTime?
  revokedBy     String?
  revokedReason String?

  // Phase 1.5: Link to amendment if this is an amendment signature
  amendmentId String?        @unique
  amendment   NoteAmendment? @relation("AmendmentSignature", fields: [amendmentId], references: [id])

  @@index([noteId, signatureType])
  @@index([userId])
  @@map("signature_events")
}

// ============================================================================
// PHASE 1.5: AMENDMENT HISTORY SYSTEM
// ============================================================================

model NoteAmendment {
  id     String       @id @default(uuid())
  noteId String
  note   ClinicalNote @relation("NoteAmendments", fields: [noteId], references: [id])

  // Amendment metadata
  amendmentNumber Int // 1, 2, 3, etc. (sequential per note)
  reason          String // Why the amendment was made
  amendedBy       String
  amendingUser    User     @relation("UserAmendments", fields: [amendedBy], references: [id])
  amendedAt       DateTime @default(now())

  // What was changed
  fieldsChanged String[] // Array of field names that were modified
  changeSummary String // Human-readable summary of changes

  // Version snapshots
  previousVersion   NoteVersion? @relation("PreviousVersion", fields: [previousVersionId], references: [id])
  previousVersionId String?
  newVersion        NoteVersion? @relation("NewVersion", fields: [newVersionId], references: [id])
  newVersionId      String?

  // Signature requirement
  requiresSignature Boolean         @default(true)
  signatureEvent    SignatureEvent? @relation("AmendmentSignature")

  // Amendment status
  status String @default("PENDING") // PENDING, SIGNED, REJECTED

  // Compliance tracking
  ipAddress String
  userAgent String

  @@index([noteId, amendmentNumber])
  @@map("note_amendments")
}

model NoteVersion {
  id     String       @id @default(uuid())
  noteId String
  note   ClinicalNote @relation("NoteVersions", fields: [noteId], references: [id])

  // Version tracking
  versionNumber Int // 1, 2, 3, etc.
  createdAt     DateTime @default(now())
  createdBy     String
  creator       User     @relation("VersionCreator", fields: [createdBy], references: [id])

  // Snapshot of note content at this version
  noteData Json // Full snapshot of the clinical note data

  // What triggered this version
  versionType                String // ORIGINAL, EDIT, AMENDMENT, REVISION
  relatedAmendmentAsPrevious NoteAmendment[] @relation("PreviousVersion")
  relatedAmendmentAsNew      NoteAmendment[] @relation("NewVersion")

  @@index([noteId, versionNumber])
  @@map("note_versions")
}

// ============================================================================
// PHASE 2.1: PAYER POLICY ENGINE & BILLING READINESS
// ============================================================================

model Payer {
  id              String      @id @default(uuid())
  name            String
  payerType       String // COMMERCIAL, MEDICAID, MEDICARE, EAP, SELF_PAY
  requiresPreAuth Boolean     @default(false)
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  rules           PayerRule[]

  @@index([payerType])
  @@index([isActive])
  @@map("payers")
}

model PayerRule {
  id      String @id @default(uuid())
  payerId String
  payer   Payer  @relation(fields: [payerId], references: [id], onDelete: Cascade)

  // Rule conditions
  clinicianCredential String // LMFT, LCSW, LPC, LAMFT, LAPC, etc.
  placeOfService      String // OFFICE, TELEHEALTH, HOME, etc.
  serviceType         String // PSYCHOTHERAPY, INTAKE, ASSESSMENT, etc.

  // Supervision requirements
  supervisionRequired        Boolean @default(false)
  cosignRequired             Boolean @default(false)
  incidentToBillingAllowed   Boolean @default(false)
  renderingClinicianOverride Boolean @default(false) // Bill under supervisor instead

  // Timeframe requirements
  cosignTimeframeDays Int? // Must cosign within X days
  noteCompletionDays  Int? // Must complete note within X days of session

  // Validation rules
  diagnosisRequired        Boolean @default(true)
  treatmentPlanRequired    Boolean @default(true)
  medicalNecessityRequired Boolean @default(true)
  priorAuthRequired        Boolean @default(false)

  // Disallowed scenarios
  isProhibited      Boolean @default(false) // This combination is not allowed
  prohibitionReason String? // Why this combination is prohibited

  // Effective dates
  effectiveDate   DateTime
  terminationDate DateTime?
  isActive        Boolean   @default(true)

  // Metadata
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  createdBy    String?
  billingHolds BillingHold[]

  @@index([payerId])
  @@index([clinicianCredential])
  @@index([serviceType])
  @@index([isActive])
  @@index([effectiveDate, terminationDate])
  @@map("payer_rules")
}

model BillingHold {
  id          String       @id @default(uuid())
  noteId      String
  note        ClinicalNote @relation(fields: [noteId], references: [id], onDelete: Cascade)
  holdReason  String // MISSING_COSIGN, PAYER_RULE_VIOLATION, MISSING_DIAGNOSIS, etc.
  holdDetails String       @db.Text // Detailed explanation of the hold

  // Related payer rule (if applicable)
  payerRuleId String?
  payerRule   PayerRule? @relation(fields: [payerRuleId], references: [id], onDelete: SetNull)

  // Hold tracking
  holdPlacedAt DateTime  @default(now())
  holdPlacedBy String // "SYSTEM" or userId
  resolvedAt   DateTime?
  resolvedBy   String?
  isActive     Boolean   @default(true)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([noteId])
  @@index([isActive])
  @@index([holdReason])
  @@index([holdPlacedAt])
  @@map("billing_holds")
}

// ============================================================================
// MODULE 2: CLIENT RELATIONSHIPS & PROVIDERS
// ============================================================================

model ClientRelationship {
  id        String @id @default(uuid())
  client1Id String
  client2Id String

  // Relationship Information
  relationshipType    String // PARENT, CHILD, SPOUSE, SIBLING, GUARDIAN, EMERGENCY_CONTACT
  relationshipDetails String? @db.Text
  isPrimary           Boolean @default(false)

  // Permissions & Access
  isEmergencyContact      Boolean @default(false)
  isAuthorizedContact     Boolean @default(false)
  canScheduleAppointments Boolean @default(false)
  canAccessPortal         Boolean @default(false)
  canReceiveInformation   Boolean @default(false)
  canMakeMedicalDecisions Boolean @default(false)
  specificLimitations     String? @db.Text

  // ROI & Consent
  roiSigned         Boolean   @default(false)
  roiSignedDate     DateTime?
  roiExpirationDate DateTime?
  consentDocumentId String?

  // Dates
  relationshipStartDate DateTime  @default(now())
  relationshipEndDate   DateTime?
  isActive              Boolean   @default(true)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  // Relations
  client1         Client          @relation("Client1Relationships", fields: [client1Id], references: [id], onDelete: Cascade)
  client2         Client          @relation("Client2Relationships", fields: [client2Id], references: [id], onDelete: Cascade)
  consentDocument ClientDocument? @relation(fields: [consentDocumentId], references: [id])
  creator         User            @relation("RelationshipCreator", fields: [createdBy], references: [id])

  @@unique([client1Id, client2Id, relationshipType])
  @@index([client1Id])
  @@index([client2Id])
  @@index([relationshipType])
  @@index([isActive])
  @@map("client_relationships")
}

model ClientProvider {
  id       String @id @default(uuid())
  clientId String

  // Provider Information
  providerType          String // PRIMARY_THERAPIST, PSYCHIATRIST, CASE_MANAGER, PCP, SPECIALIST
  providerId            String?
  externalProviderName  String? @db.VarChar(255)
  externalProviderNPI   String? @db.VarChar(10)
  externalProviderPhone String? @db.VarChar(20)
  externalProviderFax   String? @db.VarChar(20)
  externalProviderEmail String? @db.VarChar(255)
  specialty             String? @db.VarChar(255)

  // ROI & Communication
  roiSigned             Boolean   @default(false)
  roiSignedDate         DateTime?
  roiExpirationDate     DateTime?
  canReceiveUpdates     Boolean   @default(false)
  canSendReferrals      Boolean   @default(false)
  lastCommunicationDate DateTime?

  // Status
  isActive  Boolean   @default(true)
  startDate DateTime  @default(now())
  endDate   DateTime?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  // Relations
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  provider User?  @relation("InternalProvider", fields: [providerId], references: [id])
  creator  User   @relation("CreatedByUser", fields: [createdBy], references: [id])

  @@index([clientId])
  @@index([providerType])
  @@index([providerId])
  @@map("client_providers")
}

// ============================================================================
// PHASE 2: PRIOR AUTHORIZATIONS (Module 2)
// ============================================================================

model PriorAuthorization {
  id          String @id @default(uuid())
  clientId    String
  insuranceId String

  // Authorization Details
  authorizationNumber String   @unique @db.VarChar(100)
  authorizationType   String // OUTPATIENT_THERAPY, INPATIENT, ASSESSMENT, MEDICATION_MANAGEMENT
  cptCodes            String[]
  diagnosisCodes      String[]

  // Session Tracking
  sessionsAuthorized Int
  sessionsUsed       Int    @default(0)
  sessionsRemaining  Int
  sessionUnit        String @default("SESSIONS")

  // Dates
  requestDate  DateTime  @default(now())
  approvalDate DateTime?
  startDate    DateTime
  endDate      DateTime
  lastUsedDate DateTime?

  // Provider Information
  requestingProviderId String
  performingProviderId String?

  // Status
  status       String // PENDING, APPROVED, DENIED, EXPIRED, EXHAUSTED
  denialReason String? @db.Text

  // Appeal Information
  appealStatus String?
  appealDate   DateTime?
  appealNotes  String?   @db.Text

  // Documentation
  documentationSubmitted Boolean  @default(false)
  clinicalJustification  String?  @db.Text
  supportingDocuments    String[]

  // Renewal
  renewalRequested   Boolean   @default(false)
  renewalRequestDate DateTime?
  renewedFromId      String?
  renewedToId        String?

  // Notifications
  warningsSent Json?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  // Relations
  client             Client               @relation(fields: [clientId], references: [id])
  insurance          InsuranceInformation @relation(fields: [insuranceId], references: [id])
  requestingProvider User                 @relation("RequestingProvider", fields: [requestingProviderId], references: [id])
  performingProvider User?                @relation("PerformingProvider", fields: [performingProviderId], references: [id])
  renewedFrom        PriorAuthorization?  @relation("AuthRenewal", fields: [renewedFromId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  renewedTo          PriorAuthorization[] @relation("AuthRenewal")
  creator            User                 @relation("AuthCreator", fields: [createdBy], references: [id])

  @@index([clientId])
  @@index([insuranceId])
  @@index([status])
  @@index([endDate])
  @@index([sessionsRemaining])
  @@map("prior_authorizations")
}

// ============================================================================
// MODULE 3: SCHEDULING & CALENDAR MANAGEMENT - PHASE 1
// ============================================================================

// AppointmentReminder - Track all reminder attempts and responses
model AppointmentReminder {
  id               String    @id @default(uuid())
  appointmentId    String
  reminderType     String // SMS, EMAIL, VOICE, PORTAL
  scheduledFor     DateTime // When the reminder should be sent
  sentAt           DateTime?
  deliveryStatus   String // PENDING, SENT, DELIVERED, FAILED, BOUNCED
  responseReceived Boolean   @default(false)
  responseType     String? // CONFIRMED, CANCELLED, RESCHEDULED, NO_RESPONSE
  responseText     String?   @db.Text
  failureReason    String?   @db.Text
  retryCount       Int       @default(0)
  lastRetryAt      DateTime?

  // Twilio/AWS metadata
  messageId String? // External provider message ID
  cost      Float? // Track reminder costs

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([scheduledFor])
  @@index([deliveryStatus])
  @@index([sentAt])
  @@map("appointment_reminders")
}

// ReminderConfiguration - Practice-level reminder settings
model ReminderConfiguration {
  id                 String @id @default(uuid())
  practiceSettingsId String @unique

  // Reminder Schedule
  enableInitialConfirmation     Boolean @default(true) // Send immediately after booking
  enableOneWeekReminder         Boolean @default(true)
  enableTwoDayReminder          Boolean @default(true)
  enableOneDayReminder          Boolean @default(true)
  enableDayOfReminder           Boolean @default(true)
  enablePostAppointmentFollowup Boolean @default(false)

  // Time offsets (in hours before appointment)
  oneWeekOffset Int @default(168) // 7 days
  twoDayOffset  Int @default(48)
  oneDayOffset  Int @default(24)
  dayOfOffset   Int @default(2) // 2 hours before

  // Channel preferences
  defaultChannels String[] // ['SMS', 'EMAIL']
  smsEnabled      Boolean  @default(false)
  emailEnabled    Boolean  @default(true)
  voiceEnabled    Boolean  @default(false)
  portalEnabled   Boolean  @default(true)

  // SMS Configuration (Twilio)
  twilioAccountSid    String?
  twilioAuthToken     String? // Encrypted
  twilioPhoneNumber   String?
  smsTemplateInitial  String? @db.Text
  smsTemplateReminder String? @db.Text

  // Email Configuration (AWS SES)
  sesRegion            String?
  sesFromEmail         String?
  sesFromName          String?
  emailTemplateSubject String?
  emailTemplateBody    String? @db.Text
  includeIcsAttachment Boolean @default(true)

  // Voice Configuration (Twilio Voice)
  voiceScriptUrl  String?
  voiceFromNumber String?

  // Retry logic
  maxRetries        Int @default(2)
  retryDelayMinutes Int @default(60)

  // Operating hours (don't send outside these times)
  sendStartHour  Int     @default(9) // 9 AM
  sendEndHour    Int     @default(20) // 8 PM
  sendOnWeekends Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  practiceSettings PracticeSettings @relation(fields: [practiceSettingsId], references: [id])

  @@map("reminder_configurations")
}

// AppointmentType - Define appointment types with smart defaults and business rules
model AppointmentType {
  id          String  @id @default(uuid())
  typeName    String  @unique // "Initial Consultation", "Follow-up", "Group Therapy"
  category    String // INDIVIDUAL, GROUP, FAMILY, COUPLES
  description String? @db.Text

  // Scheduling defaults
  defaultDuration Int // Minutes
  bufferBefore    Int @default(0) // Minutes
  bufferAfter     Int @default(15) // Minutes

  // Business rules
  isBillable         Boolean @default(true)
  requiresAuth       Boolean @default(false) // Prior authorization required
  requiresSupervisor Boolean @default(false) // Supervision required
  maxPerDay          Int? // Max appointments of this type per day

  // Billing
  cptCode     String? // Default CPT code
  defaultRate Float? // Default charge amount

  // Visual
  colorCode String? // Hex color for calendar display
  iconName  String? // Material-UI icon name

  // Availability
  isActive           Boolean @default(true)
  allowOnlineBooking Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  appointments  Appointment[]
  groupSessions GroupSession[]

  // Module 3 Phase 4: AI Scheduling Assistant
  schedulingSuggestions SchedulingSuggestion[]
  schedulingPatterns    SchedulingPattern[]

  @@map("appointment_types")
}

// NoShowPredictionLog - Track no-show prediction accuracy and model performance
model NoShowPredictionLog {
  id            String   @id @default(uuid())
  appointmentId String
  predictedRisk Float
  actualNoShow  Boolean?
  features      Json // Store features used for prediction
  modelVersion  String
  createdAt     DateTime @default(now())

  appointment Appointment @relation(fields: [appointmentId], references: [id])

  @@index([appointmentId])
  @@index([createdAt])
  @@map("noshow_prediction_logs")
}

// ============================================================================
// MODULE 3 PHASE 2: GROUP APPOINTMENT MANAGEMENT
// ============================================================================

model GroupSession {
  id              String  @id @default(uuid())
  groupName       String
  description     String? @db.Text
  facilitatorId   String
  coFacilitatorId String?

  // Group details
  maxCapacity           Int
  currentEnrollment     Int     @default(0)
  groupType             String // THERAPY, SUPPORT, EDUCATION, SKILLS
  isOpenEnrollment      Boolean @default(false)
  requiresScreening     Boolean @default(true)
  isTelehealthAvailable Boolean @default(false)

  // Scheduling
  appointmentTypeId String
  recurringPattern  String? // WEEKLY, BIWEEKLY
  dayOfWeek         Int? // 0-6
  startTime         String? // HH:mm
  duration          Int?

  // Billing
  billingType   String // PER_MEMBER, FLAT_RATE
  ratePerMember Float?

  // Status
  status    String // ACTIVE, FULL, CLOSED, ARCHIVED
  startDate DateTime
  endDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  facilitator     User            @relation("GroupFacilitator", fields: [facilitatorId], references: [id])
  coFacilitator   User?           @relation("GroupCoFacilitator", fields: [coFacilitatorId], references: [id])
  appointmentType AppointmentType @relation(fields: [appointmentTypeId], references: [id])
  members         GroupMember[]
  sessions        Appointment[]   @relation("GroupSessions")

  @@index([facilitatorId])
  @@index([status])
  @@index([groupType])
  @@map("group_sessions")
}

model GroupMember {
  id       String @id @default(uuid())
  groupId  String
  clientId String

  enrollmentDate DateTime  @default(now())
  exitDate       DateTime?
  status         String // ACTIVE, ON_HOLD, EXITED
  exitReason     String?

  attendanceCount Int       @default(0)
  absenceCount    Int       @default(0)
  lastAttendance  DateTime?

  screenedBy     String?
  screeningDate  DateTime?
  screeningNotes String?   @db.Text
  approved       Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group      GroupSession      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  client     Client            @relation(fields: [clientId], references: [id])
  screener   User?             @relation(fields: [screenedBy], references: [id])
  attendance GroupAttendance[]

  @@unique([groupId, clientId])
  @@index([groupId])
  @@index([clientId])
  @@index([status])
  @@map("group_members")
}

model GroupAttendance {
  id            String @id @default(uuid())
  groupMemberId String
  appointmentId String

  attended    Boolean   @default(false)
  checkedInAt DateTime?
  notes       String?   @db.Text

  createdAt DateTime @default(now())

  member      GroupMember @relation(fields: [groupMemberId], references: [id], onDelete: Cascade)
  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@unique([groupMemberId, appointmentId])
  @@index([appointmentId])
  @@index([groupMemberId])
  @@map("group_attendance")
}

// ============================================================================
// MODULE 3 PHASE 2.3: PROVIDER AVAILABILITY & TIME-OFF MANAGEMENT
// ============================================================================

model ProviderAvailability {
  id         String @id @default(uuid())
  providerId String

  // Schedule
  dayOfWeek Int // 0-6 (Sunday-Saturday)
  startTime String // HH:mm
  endTime   String // HH:mm

  // Location (using officeLocationId as string for now)
  officeLocationId      String?
  isTelehealthAvailable Boolean @default(false)

  // Limits
  maxAppointments Int?

  // Overrides
  effectiveDate DateTime?
  expiryDate    DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  provider User @relation(fields: [providerId], references: [id])

  @@index([providerId, dayOfWeek])
  @@map("provider_availability")
}

model TimeOffRequest {
  id         String @id @default(uuid())
  providerId String

  // Request details
  startDate DateTime
  endDate   DateTime
  reason    String // VACATION, SICK, CONFERENCE, PERSONAL
  notes     String?  @db.Text

  // Approval
  status       String // PENDING, APPROVED, DENIED
  requestedBy  String
  approvedBy   String?
  approvedDate DateTime?
  denialReason String?   @db.Text

  // Coverage
  coverageProviderId String?
  autoReschedule     Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  provider         User  @relation("TimeOffProvider", fields: [providerId], references: [id])
  requester        User  @relation("TimeOffRequester", fields: [requestedBy], references: [id])
  approver         User? @relation("TimeOffApprover", fields: [approvedBy], references: [id])
  coverageProvider User? @relation("TimeOffCoverage", fields: [coverageProviderId], references: [id])

  @@index([providerId, startDate, endDate])
  @@map("time_off_requests")
}

// ============================================================================
// MODULE 3 PHASE 4: AI SCHEDULING ASSISTANT
// ============================================================================

// SchedulingSuggestion - Stores AI-generated scheduling recommendations
model SchedulingSuggestion {
  id             String @id @default(uuid())
  requestId      String // Links related suggestions together
  suggestionType String // OPTIMAL_SLOT, ALTERNATIVE_PROVIDER, LOAD_BALANCE, EFFICIENCY_IMPROVEMENT

  // Request context
  clientId          String?
  providerId        String?
  appointmentTypeId String?
  requestedDate     DateTime?
  requestedTime     String?
  flexibility       Int? // How many days flexible (0-30)

  // Suggestion details
  suggestedProviderId String
  suggestedDate       DateTime
  suggestedTime       String
  suggestedDuration   Int
  alternativeSlots    Json? // Array of alternative time slots

  // Scoring
  compatibilityScore Float // 0.0 to 1.0
  loadBalanceScore   Float // 0.0 to 1.0
  efficiencyScore    Float // 0.0 to 1.0
  overallScore       Float // 0.0 to 1.0
  confidenceLevel    String // LOW, MEDIUM, HIGH

  // Reasoning
  reasoning String @db.Text // Explanation for the suggestion
  factors   Json // Factors considered in the suggestion

  // Tracking
  wasAccepted          Boolean? // Did user accept this suggestion?
  acceptedAt           DateTime?
  declinedReason       String?
  createdAppointmentId String? // If accepted, link to created appointment

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client            Client?          @relation(fields: [clientId], references: [id])
  provider          User?            @relation("SuggestionProvider", fields: [providerId], references: [id])
  suggestedProvider User             @relation("SuggestedProvider", fields: [suggestedProviderId], references: [id])
  appointmentType   AppointmentType? @relation(fields: [appointmentTypeId], references: [id])

  @@index([requestId])
  @@index([clientId])
  @@index([providerId])
  @@index([suggestedProviderId])
  @@index([overallScore])
  @@index([createdAt])
  @@map("scheduling_suggestions")
}

// ProviderClientCompatibility - Stores compatibility scores between providers and clients
model ProviderClientCompatibility {
  id         String @id @default(uuid())
  providerId String
  clientId   String

  // Compatibility scores (0.0 to 1.0)
  overallScore      Float
  specialtyMatch    Float // Provider specialty matches client needs
  availabilityMatch Float // Provider availability matches client preferences
  experienceMatch   Float // Provider experience level matches client needs
  insuranceMatch    Float // Provider accepts client's insurance
  locationMatch     Float // Distance/location convenience
  styleMatch        Float // Therapy style/approach compatibility

  // Historical data
  appointmentCount  Int       @default(0)
  noShowCount       Int       @default(0)
  cancellationCount Int       @default(0)
  completionRate    Float     @default(0.0)
  lastAppointment   DateTime?

  // Factors
  factors Json // Detailed factors that influenced the score

  // Calculation metadata
  lastCalculated     DateTime @default(now())
  calculationVersion String   @default("1.0")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  provider User   @relation("CompatibilityProvider", fields: [providerId], references: [id])
  client   Client @relation(fields: [clientId], references: [id])

  @@unique([providerId, clientId])
  @@index([providerId])
  @@index([clientId])
  @@index([overallScore])
  @@map("provider_client_compatibility")
}

// SchedulingPattern - Tracks recognized patterns and inefficiencies
model SchedulingPattern {
  id          String @id @default(uuid())
  patternType String // INEFFICIENCY, OPTIMIZATION, TREND, ANOMALY
  severity    String // LOW, MEDIUM, HIGH, CRITICAL
  category    String // NO_SHOW_CLUSTER, UNDERUTILIZATION, OVERBOOKING, GAP_TIME, PREFERENCE_MISMATCH

  // Detection details
  providerId        String?
  clientId          String?
  appointmentTypeId String?
  timeRange         Json // { startDate, endDate }
  affectedDates     Json // Array of dates where pattern was detected

  // Pattern description
  title       String
  description String @db.Text
  metrics     Json // Quantitative metrics about the pattern

  // Recommendations
  recommendation  String @db.Text
  estimatedImpact String // Time saved, revenue increase, efficiency gain

  // Status
  status     String    @default("ACTIVE") // ACTIVE, RESOLVED, IGNORED
  resolvedAt DateTime?
  resolvedBy String?
  resolution String?   @db.Text

  // Detection metadata
  detectedAt DateTime @default(now())
  confidence Float // 0.0 to 1.0

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  provider        User?            @relation("PatternProvider", fields: [providerId], references: [id])
  client          Client?          @relation(fields: [clientId], references: [id])
  appointmentType AppointmentType? @relation(fields: [appointmentTypeId], references: [id])
  resolver        User?            @relation("PatternResolver", fields: [resolvedBy], references: [id])

  @@index([providerId])
  @@index([clientId])
  @@index([patternType])
  @@index([severity])
  @@index([status])
  @@index([detectedAt])
  @@map("scheduling_patterns")
}

// NaturalLanguageSchedulingLog - Logs NLP scheduling requests and parsing results
model NaturalLanguageSchedulingLog {
  id          String @id @default(uuid())
  userId      String
  requestText String @db.Text // Original natural language request

  // Parsing results
  parsedIntent   String // SCHEDULE, RESCHEDULE, CANCEL, FIND_SLOT, CHECK_AVAILABILITY
  parsedEntities Json // Extracted entities (provider, client, date, time, duration)
  confidence     Float // Parsing confidence 0.0 to 1.0
  parsingSuccess Boolean

  // Execution
  executionStatus      String // PENDING, SUCCESS, FAILED, CLARIFICATION_NEEDED
  clarificationNeeded  String? @db.Text // What needs clarification
  executedAction       String? // What action was taken
  createdAppointmentId String? // If an appointment was created

  // Performance
  parsingTimeMs   Int // Time taken to parse
  executionTimeMs Int? // Time taken to execute

  // Feedback
  userFeedback  String? // HELPFUL, NOT_HELPFUL, INCORRECT
  feedbackNotes String? @db.Text

  createdAt DateTime @default(now())

  user               User         @relation(fields: [userId], references: [id])
  createdAppointment Appointment? @relation("NLPCreatedAppointment", fields: [createdAppointmentId], references: [id])

  @@index([userId])
  @@index([parsedIntent])
  @@index([parsingSuccess])
  @@index([createdAt])
  @@map("nlp_scheduling_logs")
}

// ============================================================================
// MODULE 8: REPORTING & ANALYTICS
// ============================================================================

// ============================================================================
// DASHBOARD MODELS (3 models)
// ============================================================================

// Dashboard Configuration
model Dashboard {
  id          String   @id @default(uuid())
  userId      String // Owner
  name        String
  description String?
  layout      Json // Grid layout configuration (x, y, w, h for each widget)
  isDefault   Boolean  @default(false)
  isPublic    Boolean  @default(false)
  role        String? // If role-based default dashboard
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user    User     @relation("UserDashboards", fields: [userId], references: [id])
  widgets Widget[]

  @@index([userId])
  @@map("dashboards")
}

// Widget Instance
model Widget {
  id          String   @id @default(uuid())
  dashboardId String
  widgetType  String // 'KPI_CARD', 'LINE_CHART', 'BAR_CHART', 'TABLE', etc.
  title       String
  config      Json // Widget-specific configuration
  position    Json // Grid position { x, y, w, h }
  refreshRate Int      @default(60) // Seconds
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dashboard Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  @@index([dashboardId])
  @@map("widgets")
}

// Threshold Alerts
model ThresholdAlert {
  id            String    @id @default(uuid())
  widgetId      String?
  userId        String
  metricName    String
  operator      String
  threshold     Decimal   @db.Decimal(10, 2)
  isActive      Boolean   @default(true)
  lastTriggered DateTime?
  createdAt     DateTime  @default(now())

  user User @relation("UserAlerts", fields: [userId], references: [id])

  @@index([userId])
  @@map("threshold_alerts")
}

// ============================================================================
// PREDICTION MODELS (3 models)
// ============================================================================

// ML Model Definitions
model PredictionModel {
  id                 String   @id @default(uuid())
  modelType          String // 'NO_SHOW', 'DROPOUT', 'REVENUE_FORECAST', 'DEMAND_FORECAST'
  modelVersion       String
  algorithm          String
  features           Json
  hyperparameters    Json
  performanceMetrics Json
  trainedAt          DateTime
  isActive           Boolean  @default(false)
  createdAt          DateTime @default(now())

  trainingJobs TrainingJob[]
  predictions  Prediction[]

  @@unique([modelType, modelVersion])
  @@map("prediction_models")
}

// Model Training Jobs
model TrainingJob {
  id              String    @id @default(uuid())
  modelId         String
  datasetSize     Int
  trainTestSplit  Decimal   @db.Decimal(3, 2)
  validationScore Decimal   @db.Decimal(5, 4)
  startedAt       DateTime
  completedAt     DateTime?
  status          String
  errorMessage    String?

  model PredictionModel @relation(fields: [modelId], references: [id])

  @@index([modelId])
  @@map("training_jobs")
}

// Prediction History
model Prediction {
  id             String   @id @default(uuid())
  modelId        String
  entityType     String
  entityId       String
  predictionType String
  probability    Decimal  @db.Decimal(5, 4)
  riskLevel      String
  features       Json
  predictedAt    DateTime @default(now())

  model PredictionModel @relation(fields: [modelId], references: [id])

  @@index([entityType, entityId])
  @@index([modelId])
  @@map("predictions")
}

// ============================================================================
// REPORT MODELS (2 models)
// ============================================================================

// Report Definitions
model ReportDefinition {
  id          String   @id @default(uuid())
  userId      String
  name        String
  description String?
  category    String
  isPublic    Boolean  @default(false)
  isTemplate  Boolean  @default(false)
  queryConfig Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User             @relation("UserReports", fields: [userId], references: [id])
  versions  ReportVersion[]
  schedules ReportSchedule[]

  @@index([userId])
  @@index([category])
  @@map("report_definitions")
}

// Report Versioning
model ReportVersion {
  id            String   @id @default(uuid())
  reportId      String
  versionNumber Int
  queryConfig   Json
  changedBy     String
  changeNote    String?
  createdAt     DateTime @default(now())

  report        ReportDefinition @relation(fields: [reportId], references: [id], onDelete: Cascade)
  changedByUser User             @relation("ReportVersions", fields: [changedBy], references: [id])

  @@unique([reportId, versionNumber])
  @@index([reportId])
  @@map("report_versions")
}

// ============================================================================
// DISTRIBUTION MODELS (4 models)
// ============================================================================

// Report Schedules
model ReportSchedule {
  id                    String    @id @default(uuid())
  reportId              String
  reportType            String
  userId                String
  frequency             String
  cronExpression        String?
  timezone              String    @default("America/New_York")
  format                String
  recipients            Json
  distributionCondition Json?
  lastRunDate           DateTime?
  nextRunDate           DateTime
  status                String    @default("ACTIVE")
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  report ReportDefinition? @relation(fields: [reportId], references: [id], onDelete: Cascade)
  user   User              @relation("UserSchedules", fields: [userId], references: [id])
  logs   DeliveryLog[]

  @@index([userId])
  @@index([reportId])
  @@index([nextRunDate])
  @@map("report_schedules")
}

// Subscriptions
model Subscription {
  id             String   @id @default(uuid())
  reportId       String
  reportType     String
  userId         String
  frequency      String
  format         String
  deliveryMethod String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation("UserSubscriptions", fields: [userId], references: [id])

  @@index([userId])
  @@index([reportId])
  @@map("subscriptions")
}

// Delivery Logs
model DeliveryLog {
  id           String    @id @default(uuid())
  scheduleId   String
  reportId     String
  recipients   Json
  format       String
  status       String
  attemptCount Int       @default(1)
  sentAt       DateTime?
  errorMessage String?
  metadata     Json?
  createdAt    DateTime  @default(now())

  schedule ReportSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([scheduleId])
  @@index([status])
  @@map("delivery_logs")
}

// Distribution Lists
model DistributionList {
  id          String   @id @default(uuid())
  name        String
  description String?
  emails      Json
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator User @relation("CreatedDistributionLists", fields: [createdBy], references: [id])

  @@index([createdBy])
  @@map("distribution_lists")
}

// ============================================================================
// MODULE 9: COMPLIANCE MANAGEMENT (Agent 3)
// ============================================================================

// Policy Category Enum
enum PolicyCategory {
  CLINICAL
  ADMINISTRATIVE
  HR
  SAFETY
  IT
  FINANCIAL
  COMPLIANCE
}

// Policy Status Enum
enum PolicyStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  PUBLISHED
  ARCHIVED
}

// Policy Model
model Policy {
  id           String         @id @default(uuid())
  policyName   String
  policyNumber String         @unique
  category     PolicyCategory

  // Version Control
  version        String
  effectiveDate  DateTime
  reviewDate     DateTime
  nextReviewDate DateTime?

  // Ownership
  ownerId      String
  owner        User      @relation("PolicyOwner", fields: [ownerId], references: [id])
  approvedById String?
  approvedBy   User?     @relation("PolicyApprover", fields: [approvedById], references: [id])
  approvalDate DateTime?

  // Content
  content     String   @db.Text
  summary     String?
  attachments String[] // Document URLs

  // Distribution
  distributionList String[] // User IDs
  requireAck       Boolean                @default(false)
  acknowledgments  PolicyAcknowledgment[]

  // Status
  status   PolicyStatus @default(DRAFT)
  isActive Boolean      @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([status])
  @@index([effectiveDate])
  @@map("policies")
}

// Policy Acknowledgment Model
model PolicyAcknowledgment {
  id       String @id @default(uuid())
  policyId String
  policy   Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  userId   String
  user     User   @relation("PolicyAcknowledgments", fields: [userId], references: [id])

  acknowledgedDate DateTime @default(now())
  signature        String?
  ipAddress        String?

  @@unique([policyId, userId])
  @@index([policyId])
  @@index([userId])
  @@map("policy_acknowledgments")
}

// Incident Type Enum
enum IncidentType {
  CLINICAL
  SAFETY
  SECURITY
  COMPLIANCE
  EMPLOYEE
  EQUIPMENT
  PATIENT_COMPLAINT
  MEDICATION_ERROR
  DOCUMENTATION_ERROR
  OTHER
}

// Severity Enum
enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Investigation Status Enum
enum InvestigationStatus {
  PENDING
  IN_PROGRESS
  UNDER_REVIEW
  RESOLVED
  CLOSED
}

// Incident Model
model Incident {
  id             String @id @default(uuid())
  incidentNumber String @unique

  // Basic Information
  incidentDate DateTime
  incidentTime String?
  incidentType IncidentType
  severity     Severity

  // Location
  location         String?
  specificLocation String?

  // People
  reportedById    String
  reportedBy      User     @relation("IncidentReporter", fields: [reportedById], references: [id])
  involvedParties String[] // User IDs or names
  witnesses       String[] // Names or IDs

  // Description
  description     String  @db.Text
  immediateAction String? @db.Text

  // Investigation
  investigationStatus InvestigationStatus @default(PENDING)
  assignedToId        String?
  assignedTo          User?               @relation("IncidentInvestigator", fields: [assignedToId], references: [id])
  investigationNotes  String?             @db.Text
  rootCause           String?             @db.Text

  // Resolution
  correctiveActions Json? // Array of actions
  preventiveActions Json? // Array of actions
  followUpDate      DateTime?
  resolutionDate    DateTime?

  // Documentation
  attachments   String[] // Document URLs
  notifications Json? // Who was notified

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([incidentType])
  @@index([severity])
  @@index([investigationStatus])
  @@index([incidentDate])
  @@map("incidents")
}

// ============================================================================
// MODULE 9: TRAINING & DEVELOPMENT (AGENT 2)
// ============================================================================

// Training Type Enum - Types of training available
enum TrainingType {
  HIPAA // HIPAA compliance training
  SAFETY // Workplace safety training
  CLINICAL_COMPETENCY // Clinical skills training
  TECHNOLOGY // Technology/systems training
  COMPLIANCE // General compliance training
  SOFT_SKILLS // Communication, leadership, etc.
  CEU // Continuing Education Units
  CERTIFICATION // Professional certifications
  OTHER // Other types of training
}

// Training Category Enum - Priority/requirement level
enum TrainingCategory {
  MANDATORY // Required by law or policy
  RECOMMENDED // Recommended but not required
  OPTIONAL // Available for self-improvement
  CEU_REQUIRED // Required for license maintenance
}

// Training Status Enum - Completion status
enum TrainingStatus {
  NOT_STARTED // Not yet started
  IN_PROGRESS // Currently in progress
  COMPLETED // Successfully completed
  EXPIRED // Completed but now expired
  FAILED // Did not pass
}

// Training Record Model - Individual training completion records
model TrainingRecord {
  id     String @id @default(uuid())
  userId String
  user   User   @relation("UserTrainingRecords", fields: [userId], references: [id], onDelete: Cascade)

  // Training Information
  trainingType TrainingType
  courseName   String
  provider     String
  category     TrainingCategory

  // Dates
  assignedDate   DateTime?
  dueDate        DateTime?
  completionDate DateTime?
  expirationDate DateTime? // When training expires and needs renewal

  // Credits & Scoring
  creditsEarned   Decimal? @db.Decimal(10, 2)
  creditsRequired Decimal? @db.Decimal(10, 2)
  score           Int? // Test score if applicable
  passingScore    Int? // Minimum required score

  // Status
  status        TrainingStatus @default(NOT_STARTED)
  required      Boolean        @default(false) // Is this training required?
  complianceMet Boolean        @default(false) // Does completion meet compliance requirements?

  // Documentation
  certificateUrl String? // URL to certificate document
  notes          String?   @db.Text
  attestedBy     String? // Who attested to completion
  attestedDate   DateTime? // When attestation was made

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([required])
  @@index([expirationDate])
  @@index([trainingType])
  @@index([category])
  @@map("training_records")
}

// Course Catalog Model - Available training courses
model Course {
  id           String           @id @default(uuid())
  courseName   String
  provider     String
  description  String?          @db.Text
  duration     Int? // Duration in minutes
  credits      Decimal?         @db.Decimal(10, 2) // CEU or other credits
  trainingType TrainingType
  category     TrainingCategory

  // Content
  contentUrl String? // URL to course content/LMS
  materials  String[] // Array of material URLs or references

  // Settings
  isActive         Boolean @default(true)
  passingScore     Int? // Minimum score to pass if test required
  expirationMonths Int? // Expires X months after completion

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([trainingType])
  @@index([category])
  @@index([isActive])
  @@map("courses")
}

// ============================================================================
// MODULE 9: CREDENTIALING & LICENSING SYSTEM (Agent 1)
// ============================================================================

// Credential Type Enum
enum CredentialType {
  STATE_LICENSE
  DEA_LICENSE
  NPI
  BOARD_CERTIFICATION
  MALPRACTICE_INSURANCE
  LIABILITY_INSURANCE
  BACKGROUND_CHECK
  REFERENCE_CHECK
  OTHER
}

// Verification Status Enum
enum VerificationStatus {
  PENDING
  VERIFIED
  EXPIRED
  SUSPENDED
  REVOKED
}

// Screening Status Enum
enum ScreeningStatus {
  CLEAR
  FLAGGED
  PENDING
  ERROR
}

// Credential Model
model Credential {
  id               String         @id @default(uuid())
  userId           String
  user             User           @relation("UserCredentials", fields: [userId], references: [id], onDelete: Cascade)
  credentialType   CredentialType
  credentialNumber String
  issuingAuthority String
  issuingState     String?
  issueDate        DateTime
  expirationDate   DateTime
  renewalDate      DateTime?

  // Requirements
  ceuRequirements     Int? // Required CEU credits
  renewalRequirements Json? // Checklist of renewal requirements
  verificationStatus  VerificationStatus @default(PENDING)
  verificationDate    DateTime?
  verificationMethod  String?

  // OIG/SAM Screening
  lastScreeningDate DateTime?
  screeningStatus   ScreeningStatus @default(CLEAR)
  screeningNotes    String?

  // Documentation
  documents    String[] // Array of document URLs
  restrictions String?
  scope        String? // Scope of practice

  // Alerts
  alertsSent Json? // Track 90/60/30 day alerts

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([expirationDate])
  @@index([credentialType])
  @@index([verificationStatus])
  @@index([screeningStatus])
  @@map("credentials")
}

// expensesApproved         Expense[]                @relation("ExpenseApprover")
// purchaseOrdersRequested  PurchaseOrder[]          @relation("PORequestor")
// purchaseOrdersApproved   PurchaseOrder[]          @relation("POApprover")

// Vendor Category Enum
enum VendorCategory {
  CLINICAL_SUPPLIES
  OFFICE_SUPPLIES
  IT_SERVICES
  FACILITIES
  LEGAL
  ACCOUNTING
  HR_SERVICES
  TRAINING
  INSURANCE
  OTHER
}

// Vendor Model
model Vendor {
  id            String @id @default(uuid())
  companyName   String
  contactPerson String

  // Contact Information
  phone   String
  email   String
  address Json // Structured address object
  website String?

  // Services
  servicesProvided String[]
  category         VendorCategory

  // Contract
  contractStart DateTime?
  contractEnd   DateTime?
  contractValue Decimal?  @db.Decimal(15, 2)
  paymentTerms  String?

  // Insurance
  insuranceExpiration DateTime?
  insuranceCertUrl    String?

  // Performance
  performanceScore Int? // 1-100
  notes            String? @db.Text

  // Status
  isActive Boolean @default(true)

  // Relations
  expenses       Expense[]
  purchaseOrders PurchaseOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isActive])
  @@index([contractEnd])
  @@map("vendors")
}

// Budget Category Enum
enum BudgetCategory {
  SALARIES
  BENEFITS
  CLINICAL_SUPPLIES
  OFFICE_SUPPLIES
  EQUIPMENT
  FACILITIES
  IT
  TRAINING
  MARKETING
  PROFESSIONAL_SERVICES
  INSURANCE
  OTHER
}

// Budget Model
model Budget {
  id         String @id @default(uuid())
  name       String
  fiscalYear Int

  // Budget Details
  department String?
  category   BudgetCategory

  // Amounts
  allocatedAmount Decimal @db.Decimal(15, 2)
  spentAmount     Decimal @default(0) @db.Decimal(15, 2)
  committedAmount Decimal @default(0) @db.Decimal(15, 2)
  remainingAmount Decimal @default(0) @db.Decimal(15, 2)

  // Period
  startDate DateTime
  endDate   DateTime

  // Ownership
  ownerId String
  owner   User   @relation("BudgetOwner", fields: [ownerId], references: [id])

  // Notes
  notes String? @db.Text

  // Relations
  expenses       Expense[]
  purchaseOrders PurchaseOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fiscalYear])
  @@index([category])
  @@index([department])
  @@index([ownerId])
  @@map("budgets")
}

// Expense Status Enum
enum ExpenseStatus {
  PENDING
  APPROVED
  DENIED
  PAID
}

// Expense Model
model Expense {
  id          String         @id @default(uuid())
  description String
  category    BudgetCategory

  // Amount
  amount      Decimal  @db.Decimal(15, 2)
  taxAmount   Decimal? @db.Decimal(15, 2)
  totalAmount Decimal  @db.Decimal(15, 2)

  // Date
  expenseDate DateTime

  // Vendor
  vendorId   String?
  vendor     Vendor? @relation(fields: [vendorId], references: [id])
  vendorName String?

  // Budget
  budgetId   String?
  budget     Budget? @relation(fields: [budgetId], references: [id])
  department String?

  // Submission
  submittedById String
  submittedBy   User   @relation("ExpenseSubmitter", fields: [submittedById], references: [id])

  // Approval
  status        ExpenseStatus @default(PENDING)
  approvedById  String?
  approvedBy    User?         @relation("ExpenseApprover", fields: [approvedById], references: [id])
  approvalDate  DateTime?
  approvalNotes String?

  // Payment
  paymentMethod     String?
  receiptUrl        String?
  reimbursed        Boolean   @default(false)
  reimbursementDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([status])
  @@index([expenseDate])
  @@index([submittedById])
  @@index([approvedById])
  @@index([vendorId])
  @@index([budgetId])
  @@map("expenses")
}

// Purchase Order Status Enum
enum POStatus {
  PENDING
  APPROVED
  ORDERED
  RECEIVED
  CANCELLED
}

// Purchase Order Model
model PurchaseOrder {
  id       String @id @default(uuid())
  poNumber String @unique

  // Vendor
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  // Items
  items    Json // Array of line items with { description, quantity, unitPrice, total }
  subtotal Decimal  @db.Decimal(15, 2)
  tax      Decimal? @db.Decimal(15, 2)
  shipping Decimal? @db.Decimal(15, 2)
  total    Decimal  @db.Decimal(15, 2)

  // Dates
  orderDate    DateTime  @default(now())
  expectedDate DateTime?
  receivedDate DateTime?

  // Budget
  budgetId   String?
  budget     Budget? @relation(fields: [budgetId], references: [id])
  department String?

  // Approval
  status       POStatus  @default(PENDING)
  approvedById String?
  approvedBy   User?     @relation("POApprover", fields: [approvedById], references: [id])
  approvalDate DateTime?

  // Requester
  requestedById String
  requestedBy   User   @relation("PORequestor", fields: [requestedById], references: [id])

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([orderDate])
  @@index([vendorId])
  @@index([budgetId])
  @@index([requestedById])
  @@index([approvedById])
  @@map("purchase_orders")
}

// ============================================================================
// MODULE 9: COMMUNICATION & DOCUMENT MANAGEMENT
// ============================================================================

// Message Enums
enum RecipientType {
  INDIVIDUAL
  DEPARTMENT
  TEAM
  ALL_STAFF
  ROLE_BASED
}

enum MessageType {
  DIRECT
  BROADCAST
  ANNOUNCEMENT
  ALERT
  SHIFT_HANDOFF
}

enum MessagePriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// Internal Messaging Model
model Message {
  id       String @id @default(uuid())
  senderId String
  sender   User   @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  // Recipients
  recipientType RecipientType
  recipientIds  String[] // User IDs or channel IDs

  // Content
  subject     String?
  body        String   @db.Text
  attachments String[] // File URLs

  // Type
  messageType MessageType     @default(DIRECT)
  priority    MessagePriority @default(NORMAL)

  // Status
  isRead Boolean  @default(false)
  readBy String[] // User IDs who read
  readAt Json? // Map of userId -> timestamp

  // Thread
  threadId  String?
  replyToId String?
  replyTo   Message?  @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies   Message[] @relation("MessageReplies")

  // Archival
  isArchived Boolean   @default(false)
  expiresAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([senderId])
  @@index([threadId])
  @@index([createdAt])
  @@index([messageType])
  @@index([priority])
  @@map("messages")
}

// Channel Type Enum
enum ChannelType {
  DEPARTMENT
  TEAM
  PROJECT
  GENERAL
  ANNOUNCEMENTS
}

// Communication Channel Model
model Channel {
  id          String      @id @default(uuid())
  name        String
  description String?
  channelType ChannelType

  // Members
  memberIds String[] // User IDs
  adminIds  String[] // Admin user IDs

  // Settings
  isPrivate  Boolean @default(false)
  isArchived Boolean @default(false)

  createdById String
  createdBy   User   @relation("ChannelCreator", fields: [createdById], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([channelType])
  @@index([createdById])
  @@map("channels")
}

// Document Category Enum
enum DocumentCategory {
  POLICY
  TRAINING
  FORM
  TEMPLATE
  MEETING_MINUTES
  REPORT
  CONTRACT
  COMPLIANCE
  OTHER
}

// Document Model
model Document {
  id          String  @id @default(uuid())
  name        String
  description String?

  // File Information
  fileUrl  String
  fileType String
  fileSize Int // Size in bytes

  // Organization
  category DocumentCategory
  tags     String[]
  folderId String?
  folder   DocumentFolder?  @relation(fields: [folderId], references: [id], onDelete: SetNull)

  // Versioning
  version  String     @default("1.0")
  parentId String?
  parent   Document?  @relation("DocumentVersions", fields: [parentId], references: [id], onDelete: SetNull)
  versions Document[] @relation("DocumentVersions")

  // Ownership
  uploadedById String
  uploadedBy   User   @relation("DocumentUploader", fields: [uploadedById], references: [id], onDelete: Cascade)

  // Access Control
  isPublic   Boolean  @default(false)
  accessList String[] // User IDs with access

  // Status
  isArchived Boolean   @default(false)
  expiresAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([folderId])
  @@index([uploadedById])
  @@index([isArchived])
  @@map("documents")
}

// Document Folder Model
model DocumentFolder {
  id          String           @id @default(uuid())
  name        String
  description String?
  parentId    String?
  parent      DocumentFolder?  @relation("SubFolders", fields: [parentId], references: [id], onDelete: Cascade)
  subfolders  DocumentFolder[] @relation("SubFolders")
  documents   Document[]

  // Access Control
  isPublic   Boolean  @default(false)
  accessList String[] // User IDs with access

  createdById String
  createdBy   User   @relation("FolderCreator", fields: [createdById], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([createdById])
  @@map("document_folders")
}

// ============================================================================
// MODULE 9: HR FUNCTIONS (Performance Reviews, Time & Attendance, PTO)
// ============================================================================

// Performance Review Status Enum
enum ReviewStatus {
  DRAFT
  PENDING_SELF_EVAL
  PENDING_MANAGER_REVIEW
  PENDING_EMPLOYEE_SIGNATURE
  COMPLETED
}

// Performance Review Model
model PerformanceReview {
  id         String @id @default(uuid())
  userId     String
  user       User   @relation("ReviewedUser", fields: [userId], references: [id], onDelete: Cascade)
  reviewerId String
  reviewer   User   @relation("Reviewer", fields: [reviewerId], references: [id])

  // Review Period
  reviewPeriod   String // e.g., "Q1 2025", "Annual 2025"
  reviewDate     DateTime
  nextReviewDate DateTime?

  // Ratings (1-5 scale)
  overallRating Int
  goals         Json // Array of goals with ratings: [{ goal: string, rating: int, progress: string }]
  competencies  Json // Array of competencies with ratings: [{ competency: string, rating: int, notes: string }]

  // Feedback
  strengths    String @db.Text
  improvements String @db.Text
  actionPlans  Json // Array of action items: [{ action: string, dueDate: date, status: string }]

  // Employee Input
  selfEvaluation    String?   @db.Text
  employeeComments  String?   @db.Text
  employeeSignature String?
  employeeSignDate  DateTime?

  // Manager Input
  managerComments  String?   @db.Text
  managerSignature String?
  managerSignDate  DateTime?

  // Status
  status ReviewStatus @default(DRAFT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([reviewerId])
  @@index([reviewDate])
  @@index([status])
  @@map("performance_reviews")
}

// Absence Type Enum
enum AbsenceType {
  SICK
  PTO
  VACATION
  PERSONAL
  FMLA
  UNPAID
  BEREAVEMENT
  JURY_DUTY
  OTHER
}

// Time & Attendance Model
model TimeAttendance {
  id     String @id @default(uuid())
  userId String
  user   User   @relation("TimeAttendanceUser", fields: [userId], references: [id], onDelete: Cascade)

  date DateTime

  // Scheduled Time
  scheduledStart String? // HH:MM format
  scheduledEnd   String?

  // Actual Time
  actualStart  DateTime?
  actualEnd    DateTime?
  breakMinutes Int?

  // Calculations
  totalHours    Decimal? @db.Decimal(5, 2)
  overtimeHours Decimal? @db.Decimal(5, 2)

  // Absence
  isAbsent      Boolean      @default(false)
  absenceType   AbsenceType?
  absenceReason String?

  // Approval
  approvedById String?
  approvedBy   User?     @relation("AttendanceApprover", fields: [approvedById], references: [id])
  approvalDate DateTime?

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@index([approvedById])
  @@map("time_attendance")
}

// PTO Status Enum
enum PTOStatus {
  PENDING
  APPROVED
  DENIED
  CANCELLED
}

// PTO Request Model
model PTORequest {
  id     String @id @default(uuid())
  userId String
  user   User   @relation("PTORequestor", fields: [userId], references: [id], onDelete: Cascade)

  // Request Details
  requestType AbsenceType
  startDate   DateTime
  endDate     DateTime
  totalDays   Decimal     @db.Decimal(5, 2)

  // Reason
  reason String? @db.Text

  // Approval
  status        PTOStatus @default(PENDING)
  approvedById  String?
  approvedBy    User?     @relation("PTOApprover", fields: [approvedById], references: [id])
  approvalDate  DateTime?
  approvalNotes String?

  // Coverage
  coverageNotes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([startDate])
  @@index([approvedById])
  @@map("pto_requests")
}

// PTO Balance Model
model PTOBalance {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation("PTOBalance", fields: [userId], references: [id], onDelete: Cascade)

  // Balances (in days)
  ptoBalance      Decimal @default(0) @db.Decimal(6, 2)
  sickBalance     Decimal @default(0) @db.Decimal(6, 2)
  vacationBalance Decimal @default(0) @db.Decimal(6, 2)

  // Annual Allocation
  ptoAnnual      Decimal @default(0) @db.Decimal(6, 2)
  sickAnnual     Decimal @default(0) @db.Decimal(6, 2)
  vacationAnnual Decimal @default(0) @db.Decimal(6, 2)

  // Accrual
  accrualRate     Decimal?  @db.Decimal(6, 4) // Days per pay period
  lastAccrualDate DateTime?

  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("pto_balances")
}
